-- ============================================================================
-- back-office-api DDL Script for HSQLDB
-- ============================================================================
-- プロジェクトID: back-office-api
-- バージョン: 1.0.0
-- 最終更新日: 2026-01-08
-- 対象データベース: HSQLDB 2.7.x
-- ============================================================================

-- ============================================================================
-- テーブルの削除（既存データクリーンアップ）
-- ============================================================================
DROP TABLE IF EXISTS WORKFLOW;
DROP TABLE IF EXISTS STOCK;
DROP TABLE IF EXISTS BOOK;
DROP TABLE IF EXISTS CATEGORY;
DROP TABLE IF EXISTS PUBLISHER;
DROP TABLE IF EXISTS EMPLOYEE;
DROP TABLE IF EXISTS DEPARTMENT;

-- ============================================================================
-- 1. DEPARTMENT (部署マスタ)
-- ============================================================================
CREATE TABLE DEPARTMENT (
    DEPARTMENT_ID   BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    DEPARTMENT_NAME VARCHAR(100)
);

COMMENT ON TABLE DEPARTMENT IS '部署マスタ';
COMMENT ON COLUMN DEPARTMENT.DEPARTMENT_ID IS '部署ID（自動採番）';
COMMENT ON COLUMN DEPARTMENT.DEPARTMENT_NAME IS '部署名';

-- ============================================================================
-- 2. EMPLOYEE (社員マスタ)
-- ============================================================================
CREATE TABLE EMPLOYEE (
    EMPLOYEE_ID     BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    EMPLOYEE_CODE   VARCHAR(20),
    EMPLOYEE_NAME   VARCHAR(100),
    EMAIL           VARCHAR(100),
    PASSWORD        VARCHAR(100),
    JOB_RANK        INTEGER,
    DEPARTMENT_ID   BIGINT,
    CONSTRAINT UK_EMPLOYEE_CODE UNIQUE (EMPLOYEE_CODE),
    CONSTRAINT FK_EMPLOYEE_DEPT FOREIGN KEY (DEPARTMENT_ID) REFERENCES DEPARTMENT(DEPARTMENT_ID),
    CONSTRAINT CHK_EMPLOYEE_JOB_RANK CHECK (JOB_RANK IN (1, 2, 3))
);

COMMENT ON TABLE EMPLOYEE IS '社員マスタ';
COMMENT ON COLUMN EMPLOYEE.EMPLOYEE_ID IS '社員ID（自動採番）';
COMMENT ON COLUMN EMPLOYEE.EMPLOYEE_CODE IS '社員コード（ログインID）';
COMMENT ON COLUMN EMPLOYEE.EMPLOYEE_NAME IS '社員名';
COMMENT ON COLUMN EMPLOYEE.EMAIL IS 'メールアドレス';
COMMENT ON COLUMN EMPLOYEE.PASSWORD IS 'パスワード（BCryptハッシュ）';
COMMENT ON COLUMN EMPLOYEE.JOB_RANK IS '職務ランク（1:ASSOCIATE, 2:MANAGER, 3:DIRECTOR）';
COMMENT ON COLUMN EMPLOYEE.DEPARTMENT_ID IS '部署ID（外部キー）';

-- インデックス作成
CREATE UNIQUE INDEX UK_EMPLOYEE_CODE ON EMPLOYEE(EMPLOYEE_CODE);
CREATE INDEX IDX_EMPLOYEE_DEPT ON EMPLOYEE(DEPARTMENT_ID);

-- ============================================================================
-- 3. PUBLISHER (出版社マスタ)
-- ============================================================================
CREATE TABLE PUBLISHER (
    PUBLISHER_ID    INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PUBLISHER_NAME  VARCHAR(100)
);

COMMENT ON TABLE PUBLISHER IS '出版社マスタ';
COMMENT ON COLUMN PUBLISHER.PUBLISHER_ID IS '出版社ID（自動採番）';
COMMENT ON COLUMN PUBLISHER.PUBLISHER_NAME IS '出版社名';

-- ============================================================================
-- 4. CATEGORY (カテゴリマスタ)
-- ============================================================================
CREATE TABLE CATEGORY (
    CATEGORY_ID     INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CATEGORY_NAME   VARCHAR(100)
);

COMMENT ON TABLE CATEGORY IS 'カテゴリマスタ';
COMMENT ON COLUMN CATEGORY.CATEGORY_ID IS 'カテゴリID（自動採番）';
COMMENT ON COLUMN CATEGORY.CATEGORY_NAME IS 'カテゴリ名';

-- ============================================================================
-- 5. BOOK (書籍マスタ)
-- ============================================================================
CREATE TABLE BOOK (
    BOOK_ID         INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    BOOK_NAME       VARCHAR(200),
    AUTHOR          VARCHAR(100),
    CATEGORY_ID     INTEGER,
    PUBLISHER_ID    INTEGER,
    PRICE           DECIMAL(10, 2),
    IMAGE_URL       VARCHAR(500),
    DELETED         BOOLEAN DEFAULT FALSE,
    CONSTRAINT FK_BOOK_CATEGORY FOREIGN KEY (CATEGORY_ID) REFERENCES CATEGORY(CATEGORY_ID),
    CONSTRAINT FK_BOOK_PUBLISHER FOREIGN KEY (PUBLISHER_ID) REFERENCES PUBLISHER(PUBLISHER_ID),
    CONSTRAINT CHK_BOOK_PRICE CHECK (PRICE >= 0)
);

COMMENT ON TABLE BOOK IS '書籍マスタ';
COMMENT ON COLUMN BOOK.BOOK_ID IS '書籍ID（自動採番）';
COMMENT ON COLUMN BOOK.BOOK_NAME IS '書籍名';
COMMENT ON COLUMN BOOK.AUTHOR IS '著者名';
COMMENT ON COLUMN BOOK.CATEGORY_ID IS 'カテゴリID（外部キー）';
COMMENT ON COLUMN BOOK.PUBLISHER_ID IS '出版社ID（外部キー）';
COMMENT ON COLUMN BOOK.PRICE IS '価格';
COMMENT ON COLUMN BOOK.IMAGE_URL IS '画像URL';
COMMENT ON COLUMN BOOK.DELETED IS '削除フラグ（論理削除）';

-- インデックス作成（検索最適化）
CREATE INDEX IDX_BOOK_CATEGORY ON BOOK(CATEGORY_ID);
CREATE INDEX IDX_BOOK_PUBLISHER ON BOOK(PUBLISHER_ID);
CREATE INDEX IDX_BOOK_DELETED ON BOOK(DELETED);

-- ============================================================================
-- 6. STOCK (在庫マスタ)
-- ============================================================================
CREATE TABLE STOCK (
    BOOK_ID         INTEGER PRIMARY KEY,
    QUANTITY        INTEGER,
    VERSION         BIGINT,
    CONSTRAINT FK_STOCK_BOOK FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID),
    CONSTRAINT CHK_STOCK_QUANTITY CHECK (QUANTITY >= 0)
);

COMMENT ON TABLE STOCK IS '在庫マスタ（楽観的ロック対応）';
COMMENT ON COLUMN STOCK.BOOK_ID IS '書籍ID（外部キー）';
COMMENT ON COLUMN STOCK.QUANTITY IS '在庫数';
COMMENT ON COLUMN STOCK.VERSION IS 'バージョン番号（楽観的ロック用）';

-- ============================================================================
-- 7. WORKFLOW (ワークフロー履歴)
-- ============================================================================
CREATE TABLE WORKFLOW (
    OPERATION_ID    BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    WORKFLOW_ID     BIGINT,
    WORKFLOW_TYPE   VARCHAR(50),
    STATE           VARCHAR(20),
    BOOK_ID         INTEGER,
    BOOK_NAME       VARCHAR(200),
    AUTHOR          VARCHAR(100),
    CATEGORY_ID     INTEGER,
    PUBLISHER_ID    INTEGER,
    PRICE           DECIMAL(10, 2),
    IMAGE_URL       VARCHAR(500),
    APPLY_REASON    VARCHAR(500),
    START_DATE      DATE,
    END_DATE        DATE,
    OPERATION_TYPE  VARCHAR(20),
    OPERATED_BY     BIGINT,
    OPERATED_AT     TIMESTAMP,
    OPERATION_REASON VARCHAR(500),
    CONSTRAINT FK_WORKFLOW_BOOK FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID),
    CONSTRAINT FK_WORKFLOW_CATEGORY FOREIGN KEY (CATEGORY_ID) REFERENCES CATEGORY(CATEGORY_ID),
    CONSTRAINT FK_WORKFLOW_PUBLISHER FOREIGN KEY (PUBLISHER_ID) REFERENCES PUBLISHER(PUBLISHER_ID),
    CONSTRAINT FK_WORKFLOW_EMPLOYEE FOREIGN KEY (OPERATED_BY) REFERENCES EMPLOYEE(EMPLOYEE_ID),
    CONSTRAINT CHK_WORKFLOW_STATE CHECK (STATE IN ('CREATED', 'APPLIED', 'APPROVED', 'REJECTED')),
    CONSTRAINT CHK_WORKFLOW_TYPE CHECK (WORKFLOW_TYPE IN ('ADD_NEW_BOOK', 'REMOVE_BOOK', 'ADJUST_BOOK_PRICE')),
    CONSTRAINT CHK_WORKFLOW_OPERATION CHECK (OPERATION_TYPE IN ('CREATE', 'APPLY', 'APPROVE', 'REJECT'))
);

COMMENT ON TABLE WORKFLOW IS 'ワークフロー履歴';
COMMENT ON COLUMN WORKFLOW.OPERATION_ID IS '操作ID（主キー、自動採番）';
COMMENT ON COLUMN WORKFLOW.WORKFLOW_ID IS 'ワークフローID（複数行で共通）';
COMMENT ON COLUMN WORKFLOW.WORKFLOW_TYPE IS 'ワークフロータイプ（ADD_NEW_BOOK, REMOVE_BOOK, ADJUST_BOOK_PRICE）';
COMMENT ON COLUMN WORKFLOW.STATE IS '状態（CREATED, APPLIED, APPROVED, REJECTED）';
COMMENT ON COLUMN WORKFLOW.BOOK_ID IS '対象書籍ID';
COMMENT ON COLUMN WORKFLOW.BOOK_NAME IS '書籍名（新規追加時）';
COMMENT ON COLUMN WORKFLOW.AUTHOR IS '著者（新規追加時）';
COMMENT ON COLUMN WORKFLOW.CATEGORY_ID IS 'カテゴリID';
COMMENT ON COLUMN WORKFLOW.PUBLISHER_ID IS '出版社ID';
COMMENT ON COLUMN WORKFLOW.PRICE IS '価格';
COMMENT ON COLUMN WORKFLOW.IMAGE_URL IS '画像URL';
COMMENT ON COLUMN WORKFLOW.APPLY_REASON IS '申請理由';
COMMENT ON COLUMN WORKFLOW.START_DATE IS '適用開始日（価格改定時）';
COMMENT ON COLUMN WORKFLOW.END_DATE IS '適用終了日（価格改定時）';
COMMENT ON COLUMN WORKFLOW.OPERATION_TYPE IS '操作タイプ（CREATE, APPLY, APPROVE, REJECT）';
COMMENT ON COLUMN WORKFLOW.OPERATED_BY IS '操作者ID';
COMMENT ON COLUMN WORKFLOW.OPERATED_AT IS '操作日時';
COMMENT ON COLUMN WORKFLOW.OPERATION_REASON IS '操作理由（承認・却下時）';

-- インデックス作成
CREATE INDEX IDX_WORKFLOW_ID ON WORKFLOW(WORKFLOW_ID);
CREATE INDEX IDX_WORKFLOW_STATE ON WORKFLOW(STATE);
CREATE INDEX IDX_WORKFLOW_TYPE ON WORKFLOW(WORKFLOW_TYPE);
CREATE INDEX IDX_WORKFLOW_OPERATED_BY ON WORKFLOW(OPERATED_BY);

-- ============================================================================
-- DDLスクリプト完了
-- ============================================================================
-- 全7テーブルのDDLを作成しました。
-- - マスタテーブル: DEPARTMENT, EMPLOYEE, PUBLISHER, CATEGORY, BOOK, STOCK
-- - トランザクションテーブル: WORKFLOW
-- - 楽観的ロック: STOCKテーブルのVERSIONカラム
-- - 外部キー制約: 全てのリレーションシップに対応
-- - インデックス: 検索最適化のためのインデックスを配置
-- ============================================================================
