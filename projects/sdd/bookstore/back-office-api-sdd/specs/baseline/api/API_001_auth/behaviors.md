# 認証API 振る舞い仕様書

## 1. 概要

本ドキュメントは、認証API（`/api/auth`）の動的な振る舞いをシーケンス図、状態遷移図、フローチャートで定義する。

## 2. ログインシーケンス

### 2.1 正常系: ログイン成功

```
┌──────┐         ┌────────────┐      ┌─────────┐      ┌────────┐      ┌────────┐
│Client│         │AuthenResource│      │EmployeeDao│      │JwtUtil│      │Database│
└──┬───┘         └──────┬──────┘      └────┬────┘      └───┬────┘      └───┬────┘
   │                     │                  │                │               │
   │POST /auth/login     │                  │                │               │
   ├────────────────────►│                  │                │               │
   │{employeeCode,       │                  │                │               │
   │ password}           │                  │                │               │
   │                     │                  │                │               │
   │                     │Validate Request  │                │               │
   │                     │──────────┐       │                │               │
   │                     │          │       │                │               │
   │                     │◄─────────┘       │                │               │
   │                     │                  │                │               │
   │                     │findByCode()      │                │               │
   │                     ├─────────────────►│                │               │
   │                     │                  │SELECT          │               │
   │                     │                  ├───────────────────────────────►│
   │                     │                  │WHERE code=?    │               │
   │                     │                  │◄───────────────────────────────┤
   │                     │◄─────────────────┤Employee        │               │
   │                     │                  │                │               │
   │                     │BCrypt.checkpw()  │                │               │
   │                     │──────────┐       │                │               │
   │                     │          │       │                │               │
   │                     │◄─────────┘       │                │               │
   │                     │true              │                │               │
   │                     │                  │                │               │
   │                     │generateToken()   │                │               │
   │                     ├──────────────────────────────────►│               │
   │                     │(employeeId, code, departmentId)   │               │
   │                     │                  │                │               │
   │                     │                  │                │Build JWT      │
   │                     │                  │                │─────────┐     │
   │                     │                  │                │         │     │
   │                     │                  │                │◄────────┘     │
   │                     │◄──────────────────────────────────┤JWT Token      │
   │                     │                  │                │               │
   │                     │Build Cookie      │                │               │
   │                     │──────────┐       │                │               │
   │                     │          │       │                │               │
   │                     │◄─────────┘       │                │               │
   │                     │NewCookie         │                │               │
   │                     │                  │                │               │
   │◄────────────────────┤200 OK            │                │               │
   │LoginResponse        │Set-Cookie: JWT   │                │               │
   │                     │                  │                │               │
```

### 2.2 異常系: 社員コード不存在

```
┌──────┐         ┌────────────┐      ┌─────────┐      ┌────────┐
│Client│         │AuthenResource│      │EmployeeDao│      │Database│
└──┬───┘         └──────┬──────┘      └────┬────┘      └───┬────┘
   │                     │                  │               │
   │POST /auth/login     │                  │               │
   ├────────────────────►│                  │               │
   │{employeeCode:       │                  │               │
   │ "INVALID"}          │                  │               │
   │                     │                  │               │
   │                     │findByCode()      │               │
   │                     ├─────────────────►│               │
   │                     │                  │SELECT         │
   │                     │                  ├──────────────►│
   │                     │                  │◄──────────────┤
   │                     │◄─────────────────┤null           │
   │                     │                  │               │
   │                     │LOG WARN          │               │
   │                     │──────────┐       │               │
   │                     │          │       │               │
   │                     │◄─────────┘       │               │
   │                     │                  │               │
   │◄────────────────────┤401 Unauthorized  │               │
   │ErrorResponse        │                  │               │
   │{error: "Unauthorized",                 │               │
   │ message: "社員コードまたはパスワードが正しくありません"}  │
   │                     │                  │               │
```

### 2.3 異常系: パスワード不一致

```
┌──────┐         ┌────────────┐      ┌─────────┐      ┌────────┐
│Client│         │AuthenResource│      │EmployeeDao│      │Database│
└──┬───┘         └──────┬──────┘      └────┬────┘      └───┬────┘
   │                     │                  │               │
   │POST /auth/login     │                  │               │
   ├────────────────────►│                  │               │
   │{employeeCode,       │                  │               │
   │ password: "wrong"}  │                  │               │
   │                     │                  │               │
   │                     │findByCode()      │               │
   │                     ├─────────────────►│               │
   │                     │                  ├──────────────►│
   │                     │◄─────────────────┤Employee       │
   │                     │                  │               │
   │                     │BCrypt.checkpw()  │               │
   │                     │──────────┐       │               │
   │                     │          │       │               │
   │                     │◄─────────┘       │               │
   │                     │false             │               │
   │                     │                  │               │
   │                     │LOG WARN          │               │
   │                     │──────────┐       │               │
   │                     │          │       │               │
   │                     │◄─────────┘       │               │
   │                     │                  │               │
   │◄────────────────────┤401 Unauthorized  │               │
   │ErrorResponse        │                  │               │
   │{error: "Unauthorized",                 │               │
   │ message: "社員コードまたはパスワードが正しくありません"}  │
   │                     │                  │               │
```

## 3. ログアウトシーケンス

```
┌──────┐         ┌────────────┐
│Client│         │AuthenResource│
└──┬───┘         └──────┬──────┘
   │                     │
   │POST /auth/logout    │
   ├────────────────────►│
   │                     │
   │                     │Build Cookie (MaxAge=0)
   │                     │──────────┐
   │                     │          │
   │                     │◄─────────┘
   │                     │NewCookie (delete)
   │                     │
   │◄────────────────────┤200 OK
   │                     │Set-Cookie: JWT=; MaxAge=0
   │                     │
```

## 4. ユーザー情報取得シーケンス（未実装）

### 4.1 現在の実装（501 Not Implemented）

```
┌──────┐         ┌────────────┐
│Client│         │AuthenResource│
└──┬───┘         └──────┬──────┘
   │                     │
   │GET /auth/me         │
   ├────────────────────►│
   │Cookie: JWT          │
   │                     │
   │◄────────────────────┤501 Not Implemented
   │ErrorResponse        │
   │{error: "Not Implemented",
   │ message: "この機能は未実装です"}
   │                     │
```

### 4.2 将来の実装予定

```
┌──────┐         ┌────────────┐      ┌────────┐      ┌─────────┐      ┌────────┐
│Client│         │AuthenResource│      │JwtUtil│      │EmployeeDao│      │Database│
└──┬───┘         └──────┬──────┘      └───┬────┘      └────┬────┘      └───┬────┘
   │                     │                  │                │               │
   │GET /auth/me         │                  │                │               │
   ├────────────────────►│                  │                │               │
   │Cookie: JWT          │                  │                │               │
   │                     │                  │                │               │
   │                     │extractJwt()      │                │               │
   │                     ├─────────────────►│                │               │
   │                     │◄─────────────────┤JWT Token       │               │
   │                     │                  │                │               │
   │                     │validateToken()   │                │               │
   │                     ├─────────────────►│                │               │
   │                     │◄─────────────────┤true            │               │
   │                     │                  │                │               │
   │                     │getEmployeeId()   │                │               │
   │                     ├─────────────────►│                │               │
   │                     │◄─────────────────┤employeeId      │               │
   │                     │                  │                │               │
   │                     │findById()        │                │               │
   │                     ├───────────────────────────────────►│               │
   │                     │                  │                │SELECT         │
   │                     │                  │                ├──────────────►│
   │                     │                  │                │◄──────────────┤
   │                     │◄───────────────────────────────────┤Employee       │
   │                     │                  │                │               │
   │◄────────────────────┤200 OK            │                │               │
   │LoginResponse        │                  │                │               │
   │                     │                  │                │               │
```

## 5. 認証フローチャート

### 5.1 ログイン処理フローチャート

```
┌─────────────────┐
│     開始         │
└────────┬─────────┘
         │
         ▼
┌─────────────────┐
│ リクエスト受信    │
│ (employeeCode,   │
│  password)       │
└────────┬─────────┘
         │
         ▼
┌─────────────────┐       No
│ バリデーション    ├───────────► 400 Bad Request
│ OK?              │
└────────┬─────────┘
         │Yes
         ▼
┌─────────────────┐
│ 社員情報を検索    │
│ (employeeCode)   │
└────────┬─────────┘
         │
         ▼
┌─────────────────┐       No
│ 社員が存在?       ├───────────► 401 Unauthorized
│                  │             (LOG WARN)
└────────┬─────────┘
         │Yes
         ▼
┌─────────────────┐
│ パスワード判定    │
│ (BCrypt or 平文) │
└────────┬─────────┘
         │
         ▼
         ┌───────────────────────┐
         │ BCryptハッシュ?        │
         │ ($2a$, $2b$, $2y$)    │
         └─────┬──────────┬──────┘
               │Yes       │No
               ▼          ▼
    ┌──────────────┐  ┌──────────────┐
    │BCrypt.checkpw()  │文字列比較     │
    └────────┬─────┘  └─────┬────────┘
             │              │
             └──────┬───────┘
                    │
                    ▼
         ┌─────────────────┐       No
         │ パスワード一致?   ├───────────► 401 Unauthorized
         │                  │             (LOG WARN)
         └────────┬─────────┘
                  │Yes
                  ▼
         ┌─────────────────┐
         │ JWT生成          │
         │ (employeeId,     │
         │  employeeCode,   │
         │  departmentId)   │
         └────────┬─────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ HttpOnly Cookie  │
         │ 生成              │
         │ (MaxAge=86400s)  │
         └────────┬─────────┘
                  │
                  ▼
         ┌─────────────────┐
         │ 200 OK           │
         │ LoginResponse +  │
         │ Set-Cookie       │
         └─────────────────┘
```

### 5.2 パスワード照合フローチャート

```
┌─────────────────┐
│ パスワード取得    │
│ (DB stored)      │
└────────┬─────────┘
         │
         ▼
┌─────────────────┐
│ BCryptハッシュ?  │
│ ($2a$, $2b$,    │
│  $2y$で始まる?)  │
└────┬──────┬─────┘
     │Yes   │No
     ▼      ▼
┌─────────┐ ┌─────────┐
│BCrypt   │ │平文      │
│照合     │ │比較     │
│         │ │         │
│checkpw()│ │equals() │
└────┬────┘ └────┬────┘
     │           │
     └─────┬─────┘
           │
           ▼
    ┌─────────────┐
    │ 照合結果     │
    │ (true/false)│
    └─────────────┘
```

## 6. セッション状態遷移図

```
         ┌──────────────┐
    ────►│ 未認証        │
         │ (No Cookie)   │
         └───────┬───────┘
                 │
                 │ POST /auth/login
                 │ (成功)
                 │
         ┌───────▼───────┐
         │ 認証済み       │◄──────┐
         │ (JWT Cookie   │       │
         │  有効)         │       │ JWT有効期限内
         └───────┬───────┘       │
                 │               │
                 ├───────────────┘
                 │
                 │ POST /auth/logout
                 │ or JWT期限切れ
                 │
         ┌───────▼───────┐
         │ 未認証         │
         │ (Cookie削除)   │
         └───────────────┘
```

## 7. JWT状態遷移図

```
    ┌──────────────┐
    │ JWT未発行     │
    └──────┬───────┘
           │
           │ generateToken()
           │
    ┌──────▼───────┐
    │ JWT有効       │
    │ (exp未到達)   │
    └──────┬───────┘
           │
           │ 24時間経過
           │ or 有効期限到達
           │
    ┌──────▼───────┐
    │ JWT無効       │
    │ (exp到達)     │
    └──────────────┘
```

**備考**:
- ログアウト時はCookieを削除するだけで、JWTトークン自体は無効化されない
- トークンは有効期限まで技術的には有効（ステートレス設計）
- Cookieが削除されればブラウザから送信されなくなる

## 8. エラーハンドリングフローチャート

### 8.1 ログイン時のエラーハンドリング

```
┌─────────────────┐
│ エラー発生       │
└────────┬─────────┘
         │
         ▼
    ┌─────────────────────┐
    │ エラータイプ判定      │
    └──┬────┬────┬────┬───┘
       │    │    │    │
       ▼    ▼    ▼    ▼
    ┌───┐┌───┐┌───┐┌───┐
    │社員││パス││バリ││その│
    │不存││ワー││デー││他  │
    │在  ││ド  ││ショ││    │
    │    ││不一││ン  ││    │
    │    ││致  ││エラ││    │
    └┬──┘└┬──┘└┬──┘└┬──┘
     │    │    │    │
     │    │    │    │
     ▼    ▼    ▼    ▼
┌──────┐┌──────┐┌──────┐┌──────┐
│LOG   ││LOG   ││-     ││LOG   │
│WARN  ││WARN  ││      ││ERROR │
└──┬───┘└──┬───┘└──┬───┘└──┬───┘
   │       │       │       │
   ▼       ▼       ▼       ▼
┌──────┐┌──────┐┌──────┐┌──────┐
│401   ││401   ││400   ││500   │
│Unauth││Unauth││Bad   ││Int   │
│      ││      ││Req   ││Err   │
└──────┘└──────┘└──────┘└──────┘
```

## 9. パフォーマンス特性

### 9.1 ログイン処理時間の内訳

```
Total: ~500ms

┌─────────────────────────────────────────────────────────┐
│ DB Query (社員検索)                        100ms (20%)   │
├─────────────────────────────────────────────────────────┤
│ BCrypt Password Check                     200ms (40%)   │
├─────────────────────────────────────────────────────────┤
│ JWT Generation                             50ms (10%)   │
├─────────────────────────────────────────────────────────┤
│ Cookie Creation & Response Build          50ms (10%)   │
├─────────────────────────────────────────────────────────┤
│ その他（ネットワーク、オーバーヘッド）       100ms (20%)   │
└─────────────────────────────────────────────────────────┘
```

**ボトルネック**: BCrypt照合（意図的に遅い設計）

### 9.2 ログアウト処理時間

```
Total: ~50ms

┌─────────────────────────────────────────────────────────┐
│ Cookie Creation (MaxAge=0)                 10ms (20%)   │
├─────────────────────────────────────────────────────────┤
│ Response Build                             10ms (20%)   │
├─────────────────────────────────────────────────────────┤
│ その他（ネットワーク、オーバーヘッド）       30ms (60%)   │
└─────────────────────────────────────────────────────────┘
```

## 10. 並行処理シナリオ

### 10.1 シナリオ: 同一ユーザーの複数ログイン

```
時刻   ブラウザA                       ブラウザB
t1    POST /auth/login
      → JWT1生成 (exp: t1+24h)
t2                                    POST /auth/login
                                      → JWT2生成 (exp: t2+24h)
t3    JWT1で API呼び出し
      → 成功（JWT1はまだ有効）
t4                                    JWT2で API呼び出し
                                      → 成功（JWT2も有効）
```

**結果**: 両方のJWTが有効（ステートレス設計のため、同時に複数のJWTが有効）

### 10.2 シナリオ: ログアウト後のJWT使用

```
時刻   ユーザー                       システム
t1    POST /auth/login
      → JWT生成 (exp: t1+24h)
t2    POST /auth/logout
      → Cookie削除
t3    JWT（Cookieから削除済み）
      → ブラウザから送信されない
t4    手動でJWTを保存していた場合
      → JWTは技術的には有効
      → サーバー側でブラックリスト未実装
```

**セキュリティ考慮事項**: 
- ステートレス設計のため、ログアウト後もJWTは有効
- 将来的にJWTブラックリストの実装を検討
- 短い有効期限（デフォルト24時間）でリスク軽減

## 11. セキュリティシーケンス

### 11.1 BCryptパスワードハッシュ化（初回登録時）

```
┌──────┐         ┌────────────┐      ┌────────┐
│Admin │         │EmployeeDAO │      │Database│
└──┬───┘         └──────┬──────┘      └───┬────┘
   │                     │                  │
   │平文パスワード        │                  │
   ├────────────────────►│                  │
   │"password123"        │                  │
   │                     │                  │
   │                     │BCrypt.hashpw()   │
   │                     │──────────┐       │
   │                     │ソルト自動生成     │
   │                     │ラウンド:10       │
   │                     │◄─────────┘       │
   │                     │$2a$10$...        │
   │                     │                  │
   │                     │INSERT            │
   │                     ├─────────────────►│
   │                     │password=$2a$...  │
   │                     │                  │
   │◄────────────────────┤Success           │
   │                     │                  │
```

### 11.2 JWT検証（将来の実装）

```
┌──────┐         ┌────────────┐      ┌────────┐
│Client│         │JwtUtil     │      │秘密鍵   │
└──┬───┘         └──────┬──────┘      └───┬────┘
   │                     │                  │
   │JWT Token            │                  │
   ├────────────────────►│                  │
   │                     │                  │
   │                     │1. 構造チェック    │
   │                     │   (header.payload.signature)
   │                     │──────────┐       │
   │                     │          │       │
   │                     │◄─────────┘       │
   │                     │                  │
   │                     │2. シグネチャ検証  │
   │                     ├─────────────────►│
   │                     │HMAC-SHA256       │
   │                     │◄─────────────────┤
   │                     │verified          │
   │                     │                  │
   │                     │3. 有効期限チェック│
   │                     │   (exp > now?)   │
   │                     │──────────┐       │
   │                     │          │       │
   │                     │◄─────────┘       │
   │                     │                  │
   │◄────────────────────┤true/false        │
   │                     │                  │
```

## 12. ログ出力シーケンス

### 12.1 ログイン成功時

```
Time    Level   Message
──────────────────────────────────────────────────────────
t1      INFO    [ AuthenResource#login ] employeeCode: E0001
t2      DEBUG   [ EmployeeDao#findByCode ] Querying employee: E0001
t3      DEBUG   [ BCrypt ] Verifying password
t4      INFO    [ JwtUtil#generateToken ] Generating JWT for employee: 1
t5      INFO    [ AuthenResource#login ] Login successful: E0001
```

### 12.2 ログイン失敗時（社員不存在）

```
Time    Level   Message
──────────────────────────────────────────────────────────
t1      INFO    [ AuthenResource#login ] employeeCode: INVALID
t2      DEBUG   [ EmployeeDao#findByCode ] Querying employee: INVALID
t3      WARN    [ AuthenResource#login ] Employee not found: INVALID
```

### 12.3 ログイン失敗時（パスワード不一致）

```
Time    Level   Message
──────────────────────────────────────────────────────────
t1      INFO    [ AuthenResource#login ] employeeCode: E0001
t2      DEBUG   [ EmployeeDao#findByCode ] Querying employee: E0001
t3      DEBUG   [ BCrypt ] Verifying password
t4      WARN    [ AuthenResource#login ] Password mismatch for employeeCode: E0001
```

## 13. 将来の拡張シーケンス

### 13.1 JWT認証フィルタ（実装予定）

```
┌──────┐         ┌────────────┐      ┌────────┐      ┌────────┐
│Client│         │JwtFilter   │      │JwtUtil │      │Resource│
└──┬───┘         └──────┬──────┘      └───┬────┘      └───┬────┘
   │                     │                  │               │
   │GET /api/books       │                  │               │
   ├────────────────────►│                  │               │
   │Cookie: JWT          │                  │               │
   │                     │                  │               │
   │                     │extractJwt()      │               │
   │                     ├─────────────────►│               │
   │                     │◄─────────────────┤JWT            │
   │                     │                  │               │
   │                     │validateToken()   │               │
   │                     ├─────────────────►│               │
   │                     │◄─────────────────┤true           │
   │                     │                  │               │
   │                     │getEmployeeId()   │               │
   │                     ├─────────────────►│               │
   │                     │◄─────────────────┤employeeId     │
   │                     │                  │               │
   │                     │setSecurityContext()              │
   │                     │──────────┐       │               │
   │                     │          │       │               │
   │                     │◄─────────┘       │               │
   │                     │                  │               │
   │                     ├────────────────────────────────►│
   │                     │                  │               │
   │◄─────────────────────────────────────────────────────┤
   │200 OK               │                  │               │
   │                     │                  │               │
```

**フィルタが無効なJWTを検出した場合**:

```
┌──────┐         ┌────────────┐      ┌────────┐
│Client│         │JwtFilter   │      │JwtUtil │
└──┬───┘         └──────┬──────┘      └───┬────┘
   │                     │                  │
   │GET /api/books       │                  │
   ├────────────────────►│                  │
   │Cookie: Invalid JWT  │                  │
   │                     │                  │
   │                     │validateToken()   │
   │                     ├─────────────────►│
   │                     │◄─────────────────┤false
   │                     │                  │
   │◄────────────────────┤401 Unauthorized  │
   │                     │                  │
```

### 13.2 リフレッシュトークン（将来の拡張）

```
┌──────┐         ┌────────────┐      ┌────────┐
│Client│         │AuthenResource│      │TokenService│
└──┬───┘         └──────┬──────┘      └───┬────┘
   │                     │                  │
   │POST /auth/login     │                  │
   ├────────────────────►│                  │
   │                     │                  │
   │                     │generateTokens()  │
   │                     ├─────────────────►│
   │                     │◄─────────────────┤
   │                     │accessToken (1h)  │
   │                     │refreshToken (7d) │
   │◄────────────────────┤                  │
   │Set-Cookie:          │                  │
   │  access=...         │                  │
   │  refresh=...        │                  │
   │                     │                  │
   │                     │                  │
   │POST /auth/refresh   │                  │
   ├────────────────────►│                  │
   │Cookie: refresh      │                  │
   │                     │                  │
   │                     │validateRefresh() │
   │                     ├─────────────────►│
   │                     │◄─────────────────┤valid
   │                     │                  │
   │                     │generateAccess()  │
   │                     ├─────────────────►│
   │                     │◄─────────────────┤
   │                     │newAccessToken    │
   │◄────────────────────┤                  │
   │Set-Cookie:          │                  │
   │  access=... (new)   │                  │
   │                     │                  │
```
