# 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名

Books Stock API - バックオフィス書籍在庫管理システム

### 1.2 目的

書店のバックオフィス業務において、書籍マスタ情報、在庫情報、価格改定などを管理するためのREST APIシステムを提供する。

### 1.3 対象ユーザー

* 書店の一般社員（ASSOCIATE）：書籍情報の参照、ワークフロー作成
* 書店のマネージャー（MANAGER）：自部署のワークフロー承認
* 書店のディレクター（DIRECTOR）：全部署のワークフロー承認

## 2. 機能要件

### 2.1 認証・認可機能

* FR-AUTH-001: 社員コードとパスワードによるログイン機能
* FR-AUTH-002: JWT（JSON Web Token）による認証トークン発行
* FR-AUTH-003: HttpOnly Cookieによるトークン保持
* FR-AUTH-004: ログアウト機能
* FR-AUTH-005: 現在ログイン中のユーザー情報取得機能

### 2.2 書籍管理機能

* FR-BOOK-001: 書籍一覧取得機能
* FR-BOOK-002: 書籍詳細情報取得機能
* FR-BOOK-003: 書籍検索機能（カテゴリ・キーワード）
  * JPQL（静的クエリ）による検索
  * Criteria API（動的クエリ）による検索

### 2.3 カテゴリ管理機能

* FR-CATEGORY-001: カテゴリ一覧取得機能

### 2.4 出版社管理機能

* FR-PUBLISHER-001: 出版社一覧取得機能

### 2.5 在庫管理機能

* FR-STOCK-001: 在庫一覧取得機能
* FR-STOCK-002: 在庫情報取得機能（書籍ID指定）
* FR-STOCK-003: 在庫更新機能（楽観的ロック対応）

### 2.6 ワークフロー管理機能

* FR-WORKFLOW-001: ワークフロー作成機能
  * 新規書籍追加（ADD_NEW_BOOK）
  * 既存書籍削除（REMOVE_BOOK）
  * 書籍価格改定（ADJUST_BOOK_PRICE）
* FR-WORKFLOW-002: ワークフロー更新機能（一時保存）
* FR-WORKFLOW-003: ワークフロー申請機能
* FR-WORKFLOW-004: ワークフロー承認機能
  * 承認権限チェック（MANAGER以上）
  * 部署制限（DIRECTORは全部署可、MANAGERは同一部署のみ）
* FR-WORKFLOW-005: ワークフロー却下（差戻）機能
* FR-WORKFLOW-006: ワークフロー一覧取得機能
  * 状態・タイプによるフィルタリング
  * 権限に応じた表示制限
* FR-WORKFLOW-007: ワークフロー履歴取得機能
* FR-WORKFLOW-008: ワークフロー承認後の書籍マスタ反映機能

## 3. 非機能要件

### 3.1 性能要件

* NFR-PERF-001: APIレスポンスタイムは通常時1秒以内
* NFR-PERF-002: 同時接続ユーザー数：最大50ユーザー

### 3.2 セキュリティ要件

* NFR-SEC-001: パスワードはBCryptでハッシュ化して保存
* NFR-SEC-002: JWTトークンは256ビット以上の秘密鍵で署名
* NFR-SEC-003: JWTトークンの有効期限は24時間
* NFR-SEC-004: HttpOnly Cookieでトークンを保持しXSS対策
* NFR-SEC-005: 職務ランクによる権限制御を実施

### 3.3 可用性要件

* NFR-AVAIL-001: システム稼働率：99%以上
* NFR-AVAIL-002: トランザクション管理によるデータ整合性保証

### 3.4 保守性要件

* NFR-MAINT-001: ログレベルはSLF4Jで管理
* NFR-MAINT-002: エラーメッセージは日本語で表示
* NFR-MAINT-003: バージョン管理による楽観的ロック実装

### 3.5 移植性要件

* NFR-PORT-001: Jakarta EE準拠のアプリケーションサーバーで動作
* NFR-PORT-002: JPAによるデータベース抽象化

## 4. 制約事項

### 4.1 技術制約

* Java 17以上を使用
* Jakarta EE 10準拠
* JAX-RS（RESTful Webサービス）を使用
* JPA（Jakarta Persistence API）によるデータアクセス
* HSQLDBをデータベースとして使用
* SLF4Jによるロギング

### 4.2 業務制約

* 書籍の物理削除は行わず、論理削除（deletedフラグ）で対応
* 論理削除された書籍はAPIレスポンスから除外される（検索・一覧取得）
* 書籍詳細取得APIでは論理削除された書籍も参照可能
* ワークフローの操作履歴は全て保持（監査目的）
* 在庫更新時は楽観的ロックで排他制御

## 5. 用語集

| 用語 | 説明 |
|------|------|
| JWT | JSON Web Token - 認証情報を含むトークン |
| BCrypt | パスワードハッシュ化アルゴリズム |
| 楽観的ロック | バージョン番号による並行制御 |
| HttpOnly Cookie | JavaScriptからアクセスできないCookie |
| JPQL | Java Persistence Query Language |
| Criteria API | タイプセーフな動的クエリAPI |
| 職務ランク | ASSOCIATE(一般社員)、MANAGER(マネージャー)、DIRECTOR(ディレクター) |
| ワークフロー状態 | CREATED(作成済み)、APPLIED(申請中)、APPROVED(承認済み) |
| ワークフロータイプ | ADD_NEW_BOOK、REMOVE_BOOK、ADJUST_BOOK_PRICE |

## 6. 前提条件・事前準備

### 6.1 環境前提

* アプリケーションサーバー：Payara Server 6.x以上
* データベース：HSQLDB（組み込み or サーバーモード）
* JDK：Java 17以上

### 6.2 初期データ

* 社員マスタ（EMPLOYEE）
* 部署マスタ（DEPARTMENT）
* カテゴリマスタ（CATEGORY）
* 出版社マスタ（PUBLISHER）
* 書籍マスタ（BOOK）
* 在庫マスタ（STOCK）

## 7. 画面・帳票要件

### 7.1 画面要件

本APIシステムは画面を持たず、REST APIとしてフロントエンドアプリケーションに機能を提供する。

### 7.2 帳票要件

現時点で帳票出力要件はない。

## 8. 外部システム連携要件

現時点で外部システムとの連携要件はない。将来的には以下の連携が想定される：
* 会計システム（売上連携）
* 在庫管理システム（実在庫連携）
* メール通知システム（ワークフロー通知）

## 9. 移行要件

### 9.1 データ移行

既存システムからの移行は想定していない（新規構築）。

### 9.2 運用移行

新規システムとして段階的に導入予定。

## 10. テスト要件

### 10.1 単体テスト

* サービス層のビジネスロジックテスト
* DAO層のデータアクセステスト

### 10.2 統合テスト

* REST APIエンドポイントのテスト
* 認証・認可のテスト
* トランザクション動作のテスト

### 10.3 性能テスト

* 負荷テスト（想定同時ユーザー数）
* ストレステスト（限界値確認）

## 11. 運用要件

### 11.1 バックアップ

* データベースの日次バックアップ
* ワークフロー履歴の長期保管

### 11.2 監視

* アプリケーションログの監視
* エラー率の監視
* レスポンスタイムの監視

### 11.3 保守

* ログローテーション
* データベースメンテナンス

## 12. スケジュール

本ドキュメントはリバースエンジニアリングにより作成されたため、
実際の開発スケジュールは記載していない。

## 13. 承認

本ドキュメントはリバースエンジニアリングにより既存システムから作成された。
