# システム全体 - 受入基準

システム名: 書店バックオフィスAPI  
バージョン: 2.0.0  
最終更新日: 2025-01-02

---

## 1. 概要

本文書は、書店バックオフィスAPIシステム全体の受入基準を記述する。各機能の統合テストシナリオ、システム全体のパフォーマンス、セキュリティ、運用に関する受入基準を定義する。

---

## 2. ユーザーストーリー

### 2.1 社員ログイン

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| US-LOGIN-001 | 社員がログインできる | 社員コード・パスワードが正しい | ログイン | JWT Cookie発行<br/>書籍一覧を閲覧可能 |
| US-LOGIN-002 | ログイン後、各種APIを利用できる | ログイン済み | 書籍API, カテゴリAPI等にアクセス | 正常にレスポンス取得 |
| US-LOGIN-003 | ログアウト後、再ログインが必要 | ログアウト済み | APIアクセス（将来実装時） | 401 Unauthorized |

### 2.2 書籍検索

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| US-SEARCH-001 | カテゴリで書籍を絞り込める | カテゴリ"文学"に書籍が存在 /api/books/search?categoryId=1 | 文学カテゴリの書籍一覧取得 |
| US-SEARCH-002 | キーワードで書籍を検索できる | 書籍名に"Java"を含む書籍が存在 /api/books/search?keyword=Java | "Java"を含む書籍一覧取得 |
| US-SEARCH-003 | 詳細情報を確認できる | bookId=1が存在 /api/books/1 | 書籍詳細情報取得（カテゴリ・出版社・在庫含む） |

### 2.3 在庫管理

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| US-STOCK-001 | 在庫数を更新できる | bookId=1, quantity=10, version=1 | PU/api/stocks/1<br/>{version: 1, quantity: 15} | 在庫数が15に更新<br/>version=2 |
| US-STOCK-002 | 並行更新時、楽観的ロックが機能する | 2ユーザーが同時に更新 | 先に更新したユーザーが成功<br/>後から更新したユーザーは409 | 楽観的ロック制御により整合性確保 |

### 2.4 新規書籍追加ワークフロー

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| US-WF-001 | 一般社員が新規書籍追加を申請できる | operatedBy=1 (ASSOCIATE) | POS/api/workflows<br/>{workflowType: "ADD_NEW_BOOK"}<br/>POS/api/workflows/1/apply | ワークフロー作成・申請成功<br/>state: "APPLIED" |
| US-WF-002 | 管理職が承認できる | operatedBy=2 (MANAGER)<br/>state=APPLIED | POS/api/workflows/1/approve | 承認成功<br/>書籍マスタに反映<br/>state: "APPROVED" |
| US-WF-003 | 承認後、書籍が検索可能になる | 新規書籍が承認済み /api/books/search?keyword=新規書籍 | 新規書籍が検索結果に表示 |

---

## 3. システム統合受入基準

### 3.1 エンドツーエンドシナリオ

| シナリオID | 説明 | ステップ | 受入基準 |
|-----------|------|---------|---------|
| E2E-001 | ログインから書籍検索まで | 1. POS/api/auth/login<br/>2. GE/api/books<br/>3. GE/api/books/1 | 全ステップが成功<br/>JWT Cookieが維持される |
| E2E-002 | ワークフロー作成から承認まで | 1. POS/api/workflows<br/>2. POS/api/workflows/1/apply<br/>3. POS/api/workflows/1/approve<br/>4. GE/api/books (新規書籍確認) | 全ステップが成功<br/>新規書籍が反映される |
| E2E-003 | 在庫更新フロー | 1. GE/api/stocks/1<br/>2. PU/api/stocks/1<br/>3. GE/api/books/1 (在庫確認) | 全ステップが成功<br/>在庫数が正しく更新される |

---

## 4. データ整合性受入基準

### 4.1 外部キー整合性

| シナリオID | 説明 | 受入基準 |
|-----------|------|---------|
| DATA-001 | BOOKとCATEGORYの整合性 | 全書籍にcategoryIdが存在し、CATEGORYテーブルに対応レコードが存在 |
| DATA-002 | BOOKとPUBLISHERの整合性 | 全書籍にpublisherIdが存在し、PUBLISHERテーブルに対応レコードが存在 |
| DATA-003 | BOOKとSTOCKの整合性 | 全書籍にSTOCKレコードが存在（1:1関係） |
| DATA-004 | WORKFLOWとEMPLOYEEの整合性 | 全ワークフローにcreatedBy, operatedByが存在し、EMPLOYEEテーブルに対応レコードが存在 |

---

## 5. パフォーマンス受入基準

### 5.1 レスポンスタイム

| シナリオID | カテゴリ | 受入基準 |
|-----------|---------|---------|
| PERF-001 | 認証API | 500ms以内（95パーセンタイル） |
| PERF-002 | 書籍API | 500ms以内（95パーセンタイル） |
| PERF-003 | カテゴリAPI | 50ms以内（95パーセンタイル） |
| PERF-004 | 出版社API | 50ms以内（95パーセンタイル） |
| PERF-005 | 在庫API | 200ms以内（95パーセンタイル） |
| PERF-006 | ワークフローAPI | 1秒以内（95パーセンタイル） |

### 5.2 スループット

| シナリオID | 説明 | 受入基準 |
|-----------|------|---------|
| PERF-TH-001 | 同時リクエスト処理能力 | 100リクエスト/秒を処理可能 |
| PERF-TH-002 | 大量データ取得 | 書籍1000件を3秒以内に取得 |

### 5.3 N+1問題の防止

| シナリオID | 説明 | 受入基準 |
|-----------|------|---------|
| PERF-N1-001 | 書籍一覧取得時のSQL実行回数 | 1回のクエリで全データ取得（JOIN FETCH） |
| PERF-N1-002 | ワークフロー一覧取得時のSQL実行回数 | 1回のクエリで全データ取得 |

---

## 6. セキュリティ受入基準

### 6.1 認証・認可

| シナリオID | 説明 | 受入基準 |
|-----------|------|---------|
| SEC-001 | JWT Cookie は HttpOnly | JavaScriptからアクセス不可 |
| SEC-002 | パスワードはBCryptハッシュ化 | パスワードが平文で保存されていない（本番環境） |
| SEC-003 | JWT有効期限は24時間 | 24時間後にJWTが無効になる |
| SEC-004 | 承認権限チェック | ASSOCIATEは承認不可<br/>MANAGERは同一部署のみ<br/>DIRECTORは全部署承認可 |

### 6.2 SQLインジェクション対策

| シナリオID | 説明 | 受入基準 |
|-----------|------|---------|
| SEC-SQL-001 | JPAの名前付きパラメータ使用 | 全クエリで:parameterName形式を使用 |
| SEC-SQL-002 | Criteria APIのタイプセーフクエリ | Criteria APIでコンパイル時型チェック |
| SEC-SQL-003 | ユーザー入力の直接SQL組み立て禁止 | ユーザー入力を直接SQL文字列に連結しない |

---

## 7. トランザクション受入基準

### 7.1 トランザクション整合性

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| TRAN-001 | ワークフロー承認はアトミック | - | 承認操作 | WORKFLOW_OPERATION INSERTと<br/>BOOK INSERT/UPDATEが同時にコミット |
| TRAN-002 | エラー時は全てロールバック | BOOK INSERT失敗 | 承認操作 | WORKFLOW_OPERATIONもロールバック |
| TRAN-003 | 在庫更新はアトミック | - | 在庫更新 | quantity更新とversion更新が同時にコミット |

---

## 8. 並行処理受入基準

### 8.1 楽観的ロック

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| CONC-001 | 在庫更新時の楽観的ロック | 2ユーザーが同時に在庫更新 | 先に更新したユーザーが成功<br/>後から更新したユーザーは409 | データ整合性が確保される |
| CONC-002 | 409受信後、再取得して再試行 | 409 Conflict受信 | 最新version取得して再更新 | 再更新成功 |

---

## 9. ログ出力受入基準

### 9.1 ログレベル

| シナリオID | 説明 | ログレベル | ログ内容 |
|-----------|------|----------|---------|
| LOG-001 | API呼び出し成功 | INFO | [Resource#method] Success: ... |
| LOG-002 | ビジネスロジックエラー | WARN | [Service#method] Business logic error: ... |
| LOG-003 | システムエラー | ERROR | [Component#method] Unexpected error<br/>スタックトレース |

---

## 10. エラーハンドリング受入基準

### 10.1 エラーレスポンス

| シナリオID | 説明 | HTTPステータス | レスポンス形式 |
|-----------|------|---------------|--------------|
| ERR-001 | リソースが見つからない | 404 Not Found | {error: "...", message: "..."} |
| ERR-002 | バリデーションエラー | 400 Bad Request | {error: "...", message: "..."} |
| ERR-003 | 権限不足 | 403 Forbidden | {error: "...", message: "..."} |
| ERR-004 | 楽観的ロック失敗 | 409 Conflict | {error: "...", message: "再度お試しください"} |
| ERR-005 | システムエラー | 500 Internal Server Error | {error: "...", message: "..."} |

---

## 11. 運用受入基準

### 11.1 可用性

| シナリオID | 説明 | 受入基準 |
|-----------|------|---------|
| OPS-001 | サービス稼働率 | 99.9%以上（計画停止除く） |
| OPS-002 | 障害時の復旧時間 | 1時間以内 |

### 11.2 監視

| シナリオID | 説明 | 受入基準 |
|-----------|------|---------|
| OPS-MON-001 | レスポンスタイム監視 | 各APIのレスポンスタイムを記録 |
| OPS-MON-002 | エラー率監視 | 5xx系エラー率を記録 |
| OPS-MON-003 | ログ出力 | 全API呼び出しをログ出力 |

---

## 12. 将来の拡張受入基準

### 12.1 JWT認証フィルタ（実装予定）

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| EXT-001 | 全APIで認証必須 | JWT Cookie未設定 | 任意のAPIにアクセス | 401 Unauthorized |
| EXT-002 | 有効なJWTで認証成功 | 有効なJWT Cookie | 任意のAPIにアクセス | 200 OK |

### 12.2 ページネーション（実装予定）

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| EXT-PAGE-001 | ページサイズ指定 | - /api/books?page=0&size=20 | 20件ずつ取得 |
| EXT-PAGE-002 | 総ページ数取得 | - /api/books?page=0&size=20 | totalPages, totalElementsが含まれる |

---

## 13. 関連ドキュメント

* [architecture_design.md](architecture_design.md) - アーキテクチャ設計書
* [functional_design.md](functional_design.md) - 機能設計書
* [data_model.md](data_model.md) - データモデル
* [external_interface.md](external_interface.md) - 外部インターフェース

