# API_001_auth - 認証API受入基準

**API ID:** API_001_auth  
**API名:** 認証API  
**ベースパス:** `/api/auth`  
**バージョン:** 2.0.0  
**最終更新日:** 2025-12-27

---

## 1. 概要

本文書は、認証APIの受入基準を記述する。各エンドポイントについて、正常系・異常系の振る舞いを定義し、テストシナリオの基礎とする。

---

## 2. ログイン (`POST /api/auth/login`)

### 2.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-LOGIN-001 | 正しいメールアドレスとパスワードでログインできる | 顧客が登録されている（alice@gmail.com, password） | メールアドレス・パスワードでログインリクエスト | 200 OK<br/>JWT Cookieが発行される<br/>顧客情報が返される |
| AUTH-LOGIN-002 | BCryptハッシュ化されたパスワードでログインできる | パスワードがBCryptハッシュで保存されている | 平文パスワードでログインリクエスト | 200 OK<br/>BCrypt.checkpw()で照合成功<br/>JWT Cookieが発行される |
| AUTH-LOGIN-003 | 平文パスワード（開発環境）でログインできる | パスワードが平文で保存されている | 平文パスワードでログインリクエスト | 200 OK<br/>平文比較で照合成功<br/>JWT Cookieが発行される |

### 2.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-LOGIN-E001 | メールアドレスが存在しない場合、エラー | メールアドレスが未登録 | 未登録のメールアドレスでログインリクエスト | 401 Unauthorized<br/>"メールアドレスまたはパスワードが正しくありません" |
| AUTH-LOGIN-E002 | パスワードが一致しない場合、エラー | メールアドレスは存在するがパスワードが不一致 | 誤ったパスワードでログインリクエスト | 401 Unauthorized<br/>"メールアドレスまたはパスワードが正しくありません" |
| AUTH-LOGIN-E003 | メールアドレスが空の場合、エラー | - | メールアドレスが空でログインリクエスト | 400 Bad Request<br/>Bean Validationエラー |
| AUTH-LOGIN-E004 | パスワードが空の場合、エラー | - | パスワードが空でログインリクエスト | 400 Bad Request<br/>Bean Validationエラー |

---

## 3. ログアウト (`POST /api/auth/logout`)

### 3.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-LOGOUT-001 | ログアウトできる | ログイン済み | ログアウトリクエスト | 200 OK<br/>JWT Cookie削除（MaxAge=0） |
| AUTH-LOGOUT-002 | 未ログイン状態でもログアウトできる | 未ログイン | ログアウトリクエスト | 200 OK<br/>JWT Cookie削除（MaxAge=0） |

---

## 4. 新規登録 (`POST /api/auth/register`)

### 4.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-REG-001 | 新規顧客を登録できる | メールアドレスが未登録 | 顧客情報で登録リクエスト | 200 OK<br/>顧客が登録される<br/>パスワードがBCryptハッシュ化される<br/>JWT Cookieが発行される |
| AUTH-REG-002 | 住所が都道府県名から始まる場合、登録できる | - | address="東京都渋谷区1-2-3"で登録リクエスト | 200 OK<br/>登録成功 |
| AUTH-REG-003 | 生年月日が任意項目で登録できる | - | birthday=nullで登録リクエスト | 200 OK<br/>登録成功 |

### 4.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-REG-E001 | メールアドレスが既に存在する場合、エラー | メールアドレスが既に登録済み | 既存のメールアドレスで登録リクエスト | 409 Conflict<br/>"指定されたメールアドレスは既に登録されています" |
| AUTH-REG-E002 | 住所が都道府県名から始まらない場合、エラー | - | address="渋谷区1-2-3"で登録リクエスト | 400 Bad Request<br/>"住所は都道府県名から始めてください" |
| AUTH-REG-E003 | メールアドレスが空の場合、エラー | - | email=nullで登録リクエスト | 400 Bad Request<br/>Bean Validationエラー |
| AUTH-REG-E004 | 顧客名が空の場合、エラー | - | customerName=nullで登録リクエスト | 400 Bad Request<br/>Bean Validationエラー |
| AUTH-REG-E005 | パスワードが空の場合、エラー | - | password=nullで登録リクエスト | 400 Bad Request<br/>Bean Validationエラー |

---

## 5. 現在のログインユーザー情報取得 (`GET /api/auth/me`)

### 5.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-ME-001 | ログイン中の顧客情報を取得できる | JWT Cookieが設定されている | /api/auth/meにリクエスト | 200 OK<br/>顧客情報が返される |

### 5.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-ME-E001 | JWT Cookieが設定されていない場合、エラー | JWT Cookieが未設定 | /api/auth/meにリクエスト | 401 Unauthorized<br/>"認証が必要です" |
| AUTH-ME-E002 | JWTが無効な場合、エラー | JWT Cookieが無効（改ざん、期限切れ） | /api/auth/meにリクエスト | 401 Unauthorized<br/>"認証が必要です" |

---

## 6. JWT認証

### 6.1 JWT検証

#### 6.1.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| JWT-001 | 有効なJWT Cookieでリクエストできる | 有効なJWT Cookie | 認証必須APIにリクエスト | APIが正常に実行される<br/>AuthenContextにcustomerIdが設定される |

#### 6.1.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| JWT-E001 | JWT Cookieが設定されていない場合、認証エラー | JWT Cookie未設定 | 認証必須APIにリクエスト | 401 Unauthorized |
| JWT-E002 | JWTが無効な場合、認証エラー | JWT Cookieが改ざんされている | 認証必須APIにリクエスト | 401 Unauthorized |
| JWT-E003 | JWTが期限切れの場合、認証エラー | JWT Cookieが期限切れ | 認証必須APIにリクエスト | 401 Unauthorized |

---

## 7. セキュリティ受入基準

### 7.1 認証・認可

| シナリオID | 説明 | 受入基準 |
|-----------|------|---------|
| SEC-001 | JWT Cookie は HttpOnly | JavaScriptからアクセス不可 |
| SEC-002 | パスワードはBCryptハッシュ化 | パスワードが平文で保存されていない |
| SEC-003 | JWT有効期限は24時間 | 24時間後にJWTが無効になる |

---

## 8. パフォーマンス受入基準

### 8.1 レスポンスタイム

| シナリオID | API | 受入基準 |
|-----------|-----|---------|
| PERF-001 | POST /api/auth/login | 500ms以内（95パーセンタイル） |
| PERF-002 | POST /api/auth/register | 500ms以内（95パーセンタイル） |
| PERF-003 | GET /api/auth/me | 500ms以内（95パーセンタイル） |

---

## 9. 関連ドキュメント

* [functional_design.md](functional_design.md) - 認証API機能設計書
* [../../system/behaviors.md](../../system/behaviors.md) - 全体受入基準
* [../../system/architecture_design.md](../../system/architecture_design.md) - アーキテクチャ設計書

