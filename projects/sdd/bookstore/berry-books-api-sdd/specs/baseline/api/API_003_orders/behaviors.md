# API_003_orders - 注文API受入基準

**API ID:** API_003_orders  
**API名:** 注文API  
**ベースパス:** `/api/orders`  
**バージョン:** 2.0.0  
**最終更新日:** 2025-12-27

---

## 1. 概要

本文書は、注文APIの受入基準を記述する。各エンドポイントについて、正常系・異常系の振る舞いを定義し、テストシナリオの基礎とする。

---

## 2. 注文作成 (`POST /api/orders`)

### 2.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-CREATE-001 | 注文を作成できる | ログイン済み<br/>在庫あり（数量10, version=1） | カート情報で注文リクエスト | 200 OK<br/>注文レコードが作成される<br/>在庫が減算される<br/>OrderResponseが返される |
| ORDER-CREATE-002 | 複数書籍を同時に注文できる | ログイン済み<br/>全書籍の在庫あり | 複数カート項目で注文リクエスト | 200 OK<br/>複数の注文明細が作成される<br/>各書籍の在庫が減算される |
| ORDER-CREATE-003 | トランザクションがコミットされる | ログイン済み<br/>在庫あり | 注文リクエスト | 200 OK<br/>ORDER_TRAN, ORDER_DETAIL, STOCKが同時にコミットされる |

### 2.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-CREATE-E001 | 未ログインの場合、エラー | JWT Cookie未設定 | 注文リクエスト | 401 Unauthorized<br/>"認証が必要です" |
| ORDER-CREATE-E002 | 在庫不足の場合、エラー | 在庫数=5<br/>注文数=10 | 在庫を超える数量で注文リクエスト | 409 Conflict<br/>"在庫が不足しています: {bookName}" |
| ORDER-CREATE-E003 | 楽観的ロック競合の場合、エラー | カート追加時version=1<br/>注文時version=2（他ユーザーが購入済み） | version=1で注文リクエスト | 409 Conflict<br/>"他のユーザーが購入済みです。最新の在庫情報を確認してください。" |
| ORDER-CREATE-E004 | 在庫不足でトランザクションがロールバックされる | 1冊目は在庫あり<br/>2冊目は在庫不足 | 2冊注文リクエスト | 409 Conflict<br/>1冊目の在庫減算もロールバックされる |
| ORDER-CREATE-E005 | カート項目が空の場合、エラー | - | cartItems=[]で注文リクエスト | 400 Bad Request<br/>Bean Validationエラー |

---

## 3. 注文履歴取得 (`GET /api/orders/history`)

### 3.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-HIST-001 | ログイン中の顧客の注文履歴を取得できる | ログイン済み<br/>注文履歴あり | /api/orders/historyにリクエスト | 200 OK<br/>注文履歴が返される<br/>注文日降順でソート |
| ORDER-HIST-002 | 注文履歴が0件の場合、空配列を返す | ログイン済み<br/>注文履歴なし | /api/orders/historyにリクエスト | 200 OK<br/>空配列 [] が返される |
| ORDER-HIST-003 | 注文明細ごとに1レコードで返される | 1注文に2明細が存在する | /api/orders/historyにリクエスト | 200 OK<br/>2レコードが返される（非正規化） |

### 3.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-HIST-E001 | 未ログインの場合、エラー | JWT Cookie未設定 | /api/orders/historyにリクエスト | 401 Unauthorized<br/>"認証が必要です" |

---

## 4. 注文詳細取得 (`GET /api/orders/{tranId}`)

### 4.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-DETAIL-001 | 指定IDの注文詳細を取得できる | 注文ID=1が存在する | /api/orders/1にリクエスト | 200 OK<br/>注文詳細が返される<br/>注文明細リスト（orderDetails）を含む |

### 4.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-DETAIL-E001 | 指定IDの注文が存在しない場合、エラー | 注文ID=999が存在しない | /api/orders/999にリクエスト | 404 Not Found<br/>"注文が見つかりません" |

---

## 5. 注文明細取得 (`GET /api/orders/{tranId}/details/{detailId}`)

### 5.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-DETAIL-ITEM-001 | 指定IDの注文明細を取得できる | 注文ID=1, 明細ID=1が存在する | /api/orders/1/details/1にリクエスト | 200 OK<br/>注文明細が返される |

### 5.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-DETAIL-ITEM-E001 | 指定IDの注文明細が存在しない場合、エラー | 注文ID=1, 明細ID=999が存在しない | /api/orders/1/details/999にリクエスト | 404 Not Found<br/>"注文明細が見つかりません" |

---

## 6. 楽観的ロック制御

### 6.1 楽観的ロック制御

#### 6.1.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| LOCK-001 | 楽観的ロックが成功する | カート追加時version=1<br/>注文時もversion=1 | version=1で注文リクエスト | 200 OK<br/>在庫が減算される<br/>versionが2にインクリメントされる |

#### 6.1.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| LOCK-E001 | 楽観的ロック競合が発生する | カート追加時version=1<br/>他ユーザーが購入済み（version=2） | version=1で注文リクエスト | 409 Conflict<br/>"他のユーザーが購入済みです。最新の在庫情報を確認してください。"<br/>トランザクションがロールバックされる |
| LOCK-E002 | 複数の書籍で楽観的ロック競合が発生する | 2冊注文<br/>2冊目でversion不一致 | 注文リクエスト | 409 Conflict<br/>1冊目の在庫減算もロールバックされる |

---

## 7. トランザクション管理

### 7.1 トランザクション境界

#### 7.1.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| TXN-001 | 注文処理が単一トランザクションで実行される | - | 注文リクエスト | ORDER_TRAN, ORDER_DETAIL, STOCKが同時にコミットまたはロールバックされる |

#### 7.1.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| TXN-E001 | エラー発生時にトランザクションがロールバックされる | 2冊注文<br/>2冊目で在庫不足 | 注文リクエスト | 1冊目の在庫減算もロールバックされる<br/>データベースが変更前の状態に戻る |

---

## 8. パフォーマンス受入基準

### 8.1 レスポンスタイム

| シナリオID | API | 受入基準 |
|-----------|-----|---------|
| PERF-001 | POST /api/orders | 500ms以内（95パーセンタイル） |
| PERF-002 | GET /api/orders/history | 500ms以内（95パーセンタイル） |

---

## 9. 関連ドキュメント

* [functional_design.md](functional_design.md) - 注文API機能設計書
* [../../system/behaviors.md](../../system/behaviors.md) - 全体受入基準
* [../../system/architecture_design.md](../../system/architecture_design.md) - アーキテクチャ設計書

