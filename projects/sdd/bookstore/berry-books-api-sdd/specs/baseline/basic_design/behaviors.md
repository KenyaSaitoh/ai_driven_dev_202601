# berry-books-api - 振る舞い仕様書（受入基準）

プロジェクトID: berry-books-api  
バージョン: 2.0.0  
最終更新日: 2025-12-27  
ステータス: REST API受入基準確定

---

## 1. 概要

本文書は、berry-books-api REST APIの各機能の受入基準を記述する。各APIエンドポイントについて、正常系・異常系の振る舞いを定義し、テストシナリオの基礎とする。

### 1.1 API別受入基準

API単位の受入基準は、以下のドキュメントを参照してください：

* [API_001_auth](../detailed_design/API_001_auth/behaviors.md) - 認証APIの受入基準
* [API_002_books](../detailed_design/API_002_books/behaviors.md) - 書籍APIの受入基準
* [API_003_orders](../detailed_design/API_003_orders/behaviors.md) - 注文APIの受入基準
* [API_004_images](../detailed_design/API_004_images/behaviors.md) - 画像APIの受入基準

---

## 2. 認証API /api/auth`)

### 2.1 ログイン (`POS/api/auth/login`)

#### 2.1.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-LOGIN-001 | 正しいメールアドレスとパスワードでログインできる | 顧客が登録されている（alice@gmail.com, password） | メールアドレス・パスワードでログインリクエスト | 200 OK<br/>JWT Cookieが発行される<br/>顧客情報が返される |
| AUTH-LOGIN-002 | BCryptハッシュ化されたパスワードでログインできる | パスワードがBCryptハッシュで保存されている | 平文パスワードでログインリクエスト | 200 OK<br/>BCrypt.checkpw()で照合成功<br/>JWT Cookieが発行される |
| AUTH-LOGIN-003 | 平文パスワード（開発環境）でログインできる | パスワードが平文で保存されている | 平文パスワードでログインリクエスト | 200 OK<br/>平文比較で照合成功<br/>JWT Cookieが発行される |

#### 2.1.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-LOGIN-E001 | メールアドレスが存在しない場合、エラー | メールアドレスが未登録 | 未登録のメールアドレスでログインリクエスト | 401 Unauthorized<br/>"メールアドレスまたはパスワードが正しくありません" |
| AUTH-LOGIN-E002 | パスワードが一致しない場合、エラー | メールアドレスは存在するがパスワードが不一致 | 誤ったパスワードでログインリクエスト | 401 Unauthorized<br/>"メールアドレスまたはパスワードが正しくありません" |
| AUTH-LOGIN-E003 | メールアドレスが空の場合、エラー | - | メールアドレスが空でログインリクエスト | 400 Bad Request<br/>Bean Validationエラー |
| AUTH-LOGIN-E004 | パスワードが空の場合、エラー | - | パスワードが空でログインリクエスト | 400 Bad Request<br/>Bean Validationエラー |

---

### 2.2 ログアウト (`POS/api/auth/logout`)

#### 2.2.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-LOGOUT-001 | ログアウトできる | ログイン済み | ログアウトリクエスト | 200 OK<br/>JWT Cookie削除（MaxAge=0） |
| AUTH-LOGOUT-002 | 未ログイン状態でもログアウトできる | 未ログイン | ログアウトリクエスト | 200 OK<br/>JWT Cookie削除（MaxAge=0） |

---

### 2.3 新規登録 (`POS/api/auth/register`)

#### 2.3.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-REG-001 | 新規顧客を登録できる | メールアドレスが未登録 | 顧客情報で登録リクエスト | 200 OK<br/>顧客が登録される<br/>パスワードがBCryptハッシュ化される<br/>JWT Cookieが発行される |
| AUTH-REG-002 | 住所が都道府県名から始まる場合、登録できる | - | address="東京都渋谷区1-2-3"で登録リクエスト | 200 OK<br/>登録成功 |
| AUTH-REG-003 | 生年月日が任意項目で登録できる | - | birthday=nullで登録リクエスト | 200 OK<br/>登録成功 |

#### 2.3.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-REG-E001 | メールアドレスが既に存在する場合、エラー | メールアドレスが既に登録済み | 既存のメールアドレスで登録リクエスト | 409 Conflict<br/>"指定されたメールアドレスは既に登録されています" |
| AUTH-REG-E002 | 住所が都道府県名から始まらない場合、エラー | - | address="渋谷区1-2-3"で登録リクエスト | 400 Bad Request<br/>"住所は都道府県名から始めてください" |
| AUTH-REG-E003 | メールアドレスが空の場合、エラー | - | email=nullで登録リクエスト | 400 Bad Request<br/>Bean Validationエラー |
| AUTH-REG-E004 | 顧客名が空の場合、エラー | - | customerName=nullで登録リクエスト | 400 Bad Request<br/>Bean Validationエラー |
| AUTH-REG-E005 | パスワードが空の場合、エラー | - | password=nullで登録リクエスト | 400 Bad Request<br/>Bean Validationエラー |

---

### 2.4 現在のログインユーザー情報取得 (`GE/api/auth/me`)

#### 2.4.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-ME-001 | ログイン中の顧客情報を取得できる | JWT Cookieが設定されている /api/auth/meにリクエスト | 200 OK<br/>顧客情報が返される |

#### 2.4.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| AUTH-ME-E001 | JWT Cookieが設定されていない場合、エラー | JWT Cookieが未設定 /api/auth/meにリクエスト | 401 Unauthorized<br/>"認証が必要です" |
| AUTH-ME-E002 | JWTが無効な場合、エラー | JWT Cookieが無効（改ざん、期限切れ） /api/auth/meにリクエスト | 401 Unauthorized<br/>"認証が必要です" |

---

## 3. 書籍API /api/books`)

### 3.1 書籍一覧取得 (`GE/api/books`)

#### 3.1.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| BOOK-LIST-001 | 全書籍を取得できる | 書籍が登録されている /api/booksにリクエスト | 200 OK<br/>全書籍が返される<br/>カテゴリ、出版社、在庫情報を含む |
| BOOK-LIST-002 | 書籍が0件の場合、空配列を返す | 書籍が1件も登録されていない /api/booksにリクエスト | 200 OK<br/>空配列 [] が返される |

---

### 3.2 書籍詳細取得 (`GE/api/books/{id}`)

#### 3.2.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| BOOK-DETAIL-001 | 指定IDの書籍を取得できる | 書籍ID=1が存在する /api/books/1にリクエスト | 200 OK<br/>書籍ID=1の情報が返される<br/>カテゴリ、出版社、在庫情報を含む |

#### 3.2.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| BOOK-DETAIL-E001 | 指定IDの書籍が存在しない場合、エラー | 書籍ID=999が存在しない /api/books/999にリクエスト | 404 Not Found<br/>"書籍が見つかりません" |

---

### 3.3 書籍検索 (`GE/api/books/search`)

#### 3.3.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| BOOK-SEARCH-001 | カテゴリIDで検索できる | カテゴリID=1の書籍が存在する | categoryId=1で検索リクエスト | 200 OK<br/>カテゴリID=1の書籍が返される |
| BOOK-SEARCH-002 | キーワードで検索できる | 書籍名に"Java"を含む書籍が存在する | keyword="Java"で検索リクエスト | 200 OK<br/>書籍名または著者名に"Java"を含む書籍が返される（部分一致） |
| BOOK-SEARCH-003 | カテゴリID+キーワードで検索できる | カテゴリID=1で書籍名に"Java"を含む書籍が存在する | categoryId=1&keyword="Java"で検索 | 200 OK<br/>カテゴリID=1かつ"Java"を含む書籍が返される |
| BOOK-SEARCH-004 | categoryId=0は全カテゴリを検索する | - | categoryId=0&keyword="Java"で検索 | 200 OK<br/>全カテゴリから"Java"を含む書籍が返される |
| BOOK-SEARCH-005 | パラメータ未指定で全書籍を返す | - | パラメータなしで検索リクエスト | 200 OK<br/>全書籍が返される |
| BOOK-SEARCH-006 | 検索結果が0件の場合、空配列を返す | 該当書籍なし | keyword="存在しないキーワード"で検索 | 200 OK<br/>空配列 [] が返される |

---

### 3.4 カテゴリ一覧取得 (`GE/api/books/categories`)

#### 3.4.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| BOOK-CAT-001 | 全カテゴリをMapで取得できる | カテゴリが登録されている /api/books/categoriesにリクエスト | 200 OK<br/>カテゴリMapが返される<br/>{"Java": 1, "JavaScript": 2, ...} |

---

## 4. 注文API /api/orders`)

### 4.1 注文作成 (`POS/api/orders`)

#### 4.1.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-CREATE-001 | 注文を作成できる | ログイン済み<br/>在庫あり（数量10, version=1） | カート情報で注文リクエスト | 200 OK<br/>注文レコードが作成される<br/>在庫が減算される<br/>OrderResponseが返される |
| ORDER-CREATE-002 | 複数書籍を同時に注文できる | ログイン済み<br/>全書籍の在庫あり | 複数カート項目で注文リクエスト | 200 OK<br/>複数の注文明細が作成される<br/>各書籍の在庫が減算される |
| ORDER-CREATE-003 | トランザクションがコミットされる | ログイン済み<br/>在庫あり | 注文リクエスト | 200 OK<br/>ORDER_TRAN, ORDER_DETAIL, STOCKが同時にコミットされる |

#### 4.1.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-CREATE-E001 | 未ログインの場合、エラー | JWT Cookie未設定 | 注文リクエスト | 401 Unauthorized<br/>"認証が必要です" |
| ORDER-CREATE-E002 | 在庫不足の場合、エラー | 在庫数=5<br/>注文数=10 | 在庫を超える数量で注文リクエスト | 409 Conflict<br/>"在庫が不足しています: {bookName}" |
| ORDER-CREATE-E003 | 楽観的ロック競合の場合、エラー | カート追加時version=1<br/>注文時version=2（他ユーザーが購入済み） | version=1で注文リクエスト | 409 Conflict<br/>"他のユーザーが購入済みです。最新の在庫情報を確認してください。" |
| ORDER-CREATE-E004 | 在庫不足でトランザクションがロールバックされる | 1冊目は在庫あり<br/>2冊目は在庫不足 | 2冊注文リクエスト | 409 Conflict<br/>1冊目の在庫減算もロールバックされる |
| ORDER-CREATE-E005 | カート項目が空の場合、エラー | - | cartItems=[]で注文リクエスト | 400 Bad Request<br/>Bean Validationエラー |

---

### 4.2 注文履歴取得 (`GE/api/orders/history`)

#### 4.2.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-HIST-001 | ログイン中の顧客の注文履歴を取得できる | ログイン済み<br/>注文履歴あり /api/orders/historyにリクエスト | 200 OK<br/>注文履歴が返される<br/>注文日降順でソート |
| ORDER-HIST-002 | 注文履歴が0件の場合、空配列を返す | ログイン済み<br/>注文履歴なし /api/orders/historyにリクエスト | 200 OK<br/>空配列 [] が返される |
| ORDER-HIST-003 | 注文明細ごとに1レコードで返される | 1注文に2明細が存在する /api/orders/historyにリクエスト | 200 OK<br/>2レコードが返される（非正規化） |

#### 4.2.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-HIST-E001 | 未ログインの場合、エラー | JWT Cookie未設定 /api/orders/historyにリクエスト | 401 Unauthorized<br/>"認証が必要です" |

---

### 4.3 注文詳細取得 (`GE/api/orders/{tranId}`)

#### 4.3.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-DETAIL-001 | 指定IDの注文詳細を取得できる | 注文ID=1が存在する /api/orders/1にリクエスト | 200 OK<br/>注文詳細が返される<br/>注文明細リスト（orderDetails）を含む |

#### 4.3.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-DETAIL-E001 | 指定IDの注文が存在しない場合、エラー | 注文ID=999が存在しない /api/orders/999にリクエスト | 404 Not Found<br/>"注文が見つかりません" |

---

### 4.4 注文明細取得 (`GE/api/orders/{tranId}/details/{detailId}`)

#### 4.4.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-DETAIL-ITEM-001 | 指定IDの注文明細を取得できる | 注文ID=1, 明細ID=1が存在する /api/orders/1/details/1にリクエスト | 200 OK<br/>注文明細が返される |

#### 4.4.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| ORDER-DETAIL-ITEM-E001 | 指定IDの注文明細が存在しない場合、エラー | 注文ID=1, 明細ID=999が存在しない /api/orders/1/details/999にリクエスト | 404 Not Found<br/>"注文明細が見つかりません" |

---

## 5. 画像API /api/images`)

### 5.1 書籍表紙画像取得 (`GE/api/images/covers/{bookId}`)

#### 5.1.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| IMAGE-001 | 書籍表紙画像を取得できる | 書籍ID=1<br/>画像ファイルが存在する /api/images/covers/1にリクエスト | 200 OK<br/>Content-Type: image/jpeg<br/>画像バイナリが返される |
| IMAGE-002 | 画像が存在しない場合、フォールバック画像を返す | 書籍ID=999<br/>画像ファイルが存在しない /api/images/covers/999にリクエスト | 200 OK<br/>no-image.jpgが返される |

---

## 6. JWT認証フィルター

### 6.1 JWT検証

#### 6.1.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| JWT-001 | 有効なJWT Cookieでリクエストできる | 有効なJWT Cookie | 認証必須APIにリクエスト | APIが正常に実行される<br/>AuthenContextにcustomerIdが設定される |
| JWT-002 | JWT不要なAPIは認証なしでアクセスできる | JWT Cookie未設定 /api/books（認証不要）にリクエスト | APIが正常に実行される |

#### 6.1.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| JWT-E001 | JWT Cookieが設定されていない場合、認証エラー | JWT Cookie未設定 | 認証必須APIにリクエスト | 401 Unauthorized |
| JWT-E002 | JWTが無効な場合、認証エラー | JWT Cookieが改ざんされている | 認証必須APIにリクエスト | 401 Unauthorized |
| JWT-E003 | JWTが期限切れの場合、認証エラー | JWT Cookieが期限切れ | 認証必須APIにリクエスト | 401 Unauthorized |

---

## 7. 配送料金計算

### 7.1 配送料金計算ロジック

#### 7.1.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| DELIVERY-001 | 購入金額10,000円未満の場合、配送料800円 | 購入金額=9,999円<br/>配送先=東京都 | 配送料金計算 | 配送料金=800円 |
| DELIVERY-002 | 購入金額10,000円以上の場合、配送料無料 | 購入金額=10,000円<br/>配送先=東京都 | 配送料金計算 | 配送料金=0円 |
| DELIVERY-003 | 沖縄県の場合、配送料が異なる | 購入金額=9,999円<br/>配送先=沖縄県 | 配送料金計算 | 配送料金=1,500円（仮定） |

---

## 8. トランザクション管理

### 8.1 トランザクション境界

#### 8.1.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| TXN-001 | 注文処理が単一トランザクションで実行される | - | 注文リクエスト | ORDER_TRAN, ORDER_DETAIL, STOCKが同時にコミットまたはロールバックされる |

#### 8.1.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| TXN-E001 | エラー発生時にトランザクションがロールバックされる | 2冊注文<br/>2冊目で在庫不足 | 注文リクエスト | 1冊目の在庫減算もロールバックされる<br/>データベースが変更前の状態に戻る |

---

## 9. 並行制御（楽観的ロック）

### 9.1 楽観的ロック制御

#### 9.1.1 正常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| LOCK-001 | 楽観的ロックが成功する | カート追加時version=1<br/>注文時もversion=1 | version=1で注文リクエスト | 200 OK<br/>在庫が減算される<br/>versionが2にインクリメントされる |

#### 9.1.2 異常系

| シナリオID | 説明 | Given（前提条件） | When（操作） | Then（期待結果） |
|-----------|------|----------------|------------|---------------|
| LOCK-E001 | 楽観的ロック競合が発生する | カート追加時version=1<br/>他ユーザーが購入済み（version=2） | version=1で注文リクエスト | 409 Conflict<br/>"他のユーザーが購入済みです。最新の在庫情報を確認してください。"<br/>トランザクションがロールバックされる |
| LOCK-E002 | 複数の書籍で楽観的ロック競合が発生する | 2冊注文<br/>2冊目でversion不一致 | 注文リクエスト | 409 Conflict<br/>1冊目の在庫減算もロールバックされる |

---

## 10. パフォーマンス受入基準

### 10.1 レスポンスタイム

| シナリオID | API | 受入基準 |
|-----------|-----|---------|
| PERF-001 | GE/api/books | 500ms以内（95パーセンタイル） |
| PERF-002 | GE/api/books/search | 500ms以内（95パーセンタイル） |
| PERF-003 | POS/api/orders | 500ms以内（95パーセンタイル） |
| PERF-004 | GE/api/orders/history | 500ms以内（95パーセンタイル） |

### 10.2 スループット

| シナリオID | 受入基準 |
|-----------|---------|
| PERF-010 | 100 req/sec以上を処理できる |

---

## 11. セキュリティ受入基準

### 11.1 認証・認可

| シナリオID | 説明 | 受入基準 |
|-----------|------|---------|
| SEC-001 | JWT Cookie は HttpOnly | JavaScriptからアクセス不可 |
| SEC-002 | パスワードはBCryptハッシュ化 | パスワードが平文で保存されていない |
| SEC-003 | 認証必須APIは未認証でアクセス不可 | 401 Unauthorized |

---

## 12. 参考資料

本振る舞い仕様書に関連する詳細ドキュメント：

* [requirements.md](requirements.md) - 要件定義書
* [functional_design.md](functional_design.md) - 機能設計書（API仕様）
* [architecture_design.md](architecture_design.md) - アーキテクチャ設計書
* [data_model.md](data_model.md) - データモデル仕様書
* [external_interface.md](external_interface.md) - 外部インターフェース仕様書
* [README.md](../../README.md) - プロジェクトREADME
