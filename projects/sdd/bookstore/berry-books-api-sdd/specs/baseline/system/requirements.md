# berry-books-api - 要件定義書

プロジェクトID: berry-books-api  
バージョン: 2.0.0  
最終更新日: 2025-12-27  
ステータス: REST API仕様確定

---

## 1. プロジェクト概要

### 1.1 構築するもの

berry-books-apiは、オンライン書店「Berry Books」のBFF（Backend for Frontend）として機能するREST APIアプリケーションです。フロントエンド（berry-books-spa）の唯一のエントリーポイントとして、複数のバックエンドマイクロサービスを統合し、JWT認証、注文処理、API統合などのEC機能をREST APIとして提供します。

### 1.2 プロジェクトの目的

本システムは、フロントエンド（React SPA等）から利用されるバックエンドAPIを提供し、以下を実現することを目的とします：

* BFFパターン: フロントエンドに最適化された単一のAPIエントリーポイント
* マイクロサービス統合: 複数のバックエンドAPI（back-office-api、customer-hub-api）を統合
* API-First開発: 明確なAPI仕様に基づく開発
* JWT認証: ステートレスな認証機構による水平スケーラビリティ
* プロキシパターン: 書籍・在庫情報はバックエンドAPIに透過的に転送

---

## 2. ビジネス目標と成功指標

### 2.1 ビジネス目標

| 目標 | 説明 |
|------|------|
| BFFパターンの実現 | フロントエンド最適化された単一APIエントリーポイント |
| マイクロサービス統合 | 複数のバックエンドサービスの透過的な統合 |
| マルチチャネル対応 | Web、モバイルアプリなど複数チャネルからの利用 |
| スケーラビリティ | ステートレスなJWT認証による水平スケーリング |
| 在庫管理の正確性 | 楽観的ロック（back-office-api）による在庫不整合の防止 |

### 2.2 成功指標

| 指標 | 目標値 |
|------|--------|
| APIレスポンスタイム | 500ms以内（95パーセンタイル） |
| エラー率 | 0.1%以下 |
| 同時リクエスト処理数 | 100req/sec |
| 在庫不整合の発生率 | 0% |

---

## 3. ユーザーペルソナ

### 3.1 フロントエンド開発者

* プロフィール:
  * 役割: React/Vue.js等のSPAフロントエンド開発者
  * 目的: バックエンドAPIを利用してユーザーインターフェースを構築
  * 技術レベル: REST API、JWT認証の知識あり

* ニーズ:
  * 明確で一貫性のあるAPI仕様
  * 詳細なエラーメッセージ
  * APIドキュメントの充実
  * CORS対応

* 課題:
  * API仕様が不明瞭
  * エラーハンドリングが困難
  * 認証フローが複雑

### 3.2 エンドユーザー（間接的）

* プロフィール:
  * 年齢: 20-50代
  * 目的: 技術書・専門書の購入
  * デバイス: PC、タブレット、スマートフォン
  * 技術レベル: 基本的なWeb操作ができる

* ニーズ:
  * 高速なレスポンス
  * 安全な認証・決済
  * 正確な在庫情報
  * 過去の注文履歴参照

---

## 4. 対象業務・対象外業務

### 4.1 対象業務

本システムが対象とする業務範囲を以下に示す。

#### 4.1.1 認証・認可業務
* 新規顧客登録（REST API経由）
* ログイン・ログアウト（JWT発行・無効化）
* JWT検証とユーザー情報取得

#### 4.1.2 書籍管理業務
* 書籍一覧取得
* 書籍詳細取得
* カテゴリ別検索
* キーワード検索
* カテゴリ一覧取得
* 書籍表紙画像配信

#### 4.1.3 注文管理業務
* 注文作成（在庫引き当て含む）
* 注文履歴取得
* 注文詳細取得
* 在庫の自動減算
* 楽観的ロックによる並行制御

#### 4.1.4 配送料金計算業務
* 購入金額に応じた配送料金の自動計算
* 配送先地域（沖縄県）に応じた料金算定

### 4.2 対象外業務

以下の業務は本システムの対象外である。

#### 4.2.1 UI/UX提供業務
* ユーザーインターフェースの提供（別のReactアプリが担当）
* 画面遷移制御
* クライアントサイドバリデーション

#### 4.2.2 書籍マスタ管理業務
* 書籍マスタの登録・更新・削除
* 在庫の補充処理
* 出版社・カテゴリマスタの管理

#### 4.2.3 決済業務
* 実際の決済処理（決済方法の選択のみ実装）
* クレジットカード決済連携
* 銀行振込の入金確認

#### 4.2.4 配送業務
* 配送業者への配送依頼
* 配送状況の追跡
* 配送完了の通知

#### 4.2.5 マーケティング業務
* メールマガジン配信
* クーポン・キャンペーン管理
* レビュー・評価管理

---

## 5. APIエンドポイント一覧

### 5.1 認証API (`/api/auth`)

| メソッド | エンドポイント | 説明 | 認証 | 優先度 |
|---------|--------------|------|-----|--------|
| POST | `/api/auth/login` | ログイン（JWT Cookie発行） | 不要 | 高 |
| POST | `/api/auth/logout` | ログアウト（Cookie削除） | 不要 | 高 |
| POST | `/api/auth/register` | 新規登録 | 不要 | 高 |
| GET | `/api/auth/me` | 現在のログインユーザー情報取得 | 必須 | 高 |

### 5.2 書籍API (`/api/books`)

| メソッド | エンドポイント | 説明 | 認証 | 優先度 |
|---------|--------------|------|-----|--------|
| GET | `/api/books` | 全書籍取得 | 不要 | 高 |
| GET | `/api/books/{id}` | 書籍詳細取得 | 不要 | 高 |
| GET | `/api/books/search?categoryId={id}&keyword={keyword}` | 書籍検索 | 不要 | 高 |
| GET | `/api/books/categories` | カテゴリ一覧取得 | 不要 | 中 |

### 5.3 注文API (`/api/orders`)

| メソッド | エンドポイント | 説明 | 認証 | 優先度 |
|---------|--------------|------|-----|--------|
| POST | `/api/orders` | 注文作成 | 必須 | 高 |
| GET | `/api/orders/history` | 注文履歴取得 | 必須 | 高 |
| GET | `/api/orders/{tranId}` | 注文詳細取得 | 不要 | 中 |
| GET | `/api/orders/{tranId}/details/{detailId}` | 注文明細取得 | 不要 | 中 |

### 5.4 画像API (`/api/images`)

| メソッド | エンドポイント | 説明 | 認証 | 優先度 |
|---------|--------------|------|-----|--------|
| GET | `/api/images/covers/{bookId}` | 書籍表紙画像取得 | 不要 | 中 |

---

## 6. 非機能要件

### 6.1 パフォーマンス要件

| 項目 | 要件 |
|------|------|
| APIレスポンスタイム | 500ms以内（95パーセンタイル） |
| スループット | 100 req/sec以上 |
| 同時接続数 | 100接続 |
| データベースクエリ最適化 | N+1問題の回避（JOIN FETCH使用） |

### 6.2 セキュリティ要件

| 要件 | 説明 |
|------|------|
| 認証方式 | JWT（JSON Web Token） |
| Cookie設定 | HttpOnly Cookie（XSS対策） |
| パスワード保存 | BCryptハッシュ化 |
| 入力検証 | Bean Validation（サーバーサイド） |
| SQLインジェクション対策 | JPA/JPQLの使用 |
| CORS設定 | 許可されたオリジンのみアクセス可能 |

### 6.3 信頼性要件

| 要件 | 説明 |
|------|------|
| データ整合性 | 楽観的ロック（@Version）で在庫不整合を防止 |
| トランザクション | @Transactionalによる単一トランザクション |
| エラーハンドリング | Exception Mapperで統一的なエラーレスポンス |
| ログ出力 | SLF4J + Log4j2による構造化ログ |

### 6.4 可用性要件

| 要件 | 説明 |
|------|------|
| 稼働率 | 99.9% |
| ステートレス設計 | JWT認証によるステートレスAPI |
| 水平スケーリング | 複数インスタンスでの動作可能 |

---

## 7. 外部インターフェース（BFFパターン）

### 7.1 customer-hub-api連携

* 連携先: customer-hub-api

* 連携方式: REST API (JAX-RS 3.1)

* 目的: CUSTOMERテーブルへのアクセス（顧客情報取得、認証、登録）

* 主要エンドポイント:
  * `GET /customers/{customerId}` - 顧客取得
  * `GET /customers/query_email?email={email}` - メールアドレス検索（ログイン用）
  * `POST /customers/` - 顧客新規登録

* 詳細: [external_interface.md](external_interface.md) を参照

### 7.2 back-office-api連携

* 連携先: back-office-api

* 連携方式: REST API (JAX-RS 3.1)

* 目的: BOOK、STOCK、CATEGORY、PUBLISHERテーブルへのアクセス（書籍・在庫管理）

* 主要エンドポイント:
  * `GET /books` - 全書籍取得
  * `GET /books/{bookId}` - 書籍詳細取得
  * `GET /books/search/jpql` - 書籍検索（JPQL版）
  * `GET /books/search/criteria` - 書籍検索（Criteria API版）
  * `GET /categories` - カテゴリ一覧取得
  * `GET /stocks/{bookId}` - 在庫取得
  * `PUT /stocks/{bookId}` - 在庫更新（楽観的ロック対応）

* 詳細: [external_interface.md](external_interface.md) を参照

---

## 8. 前提条件・制約事項

### 8.1 前提条件

#### 8.1.1 技術前提

| 項目 | 内容 |
|------|------|
| JDK | 21以上 |
| Jakarta EE | 10 |
| アプリケーションサーバー | Payara Server 6.x |
| データベース | HSQLDB 2.7.x |
| ビルドツール | Gradle 8.x |

#### 8.1.2 データ前提

| 項目 | 内容 |
|------|------|
| 書籍マスタ | 事前に登録されていること |
| カテゴリマスタ | 事前に登録されていること |
| 出版社マスタ | 事前に登録されていること |
| 在庫マスタ | 各書籍の在庫情報が登録されていること |

#### 8.1.3 セキュリティ前提

| 項目 | 内容 |
|------|------|
| JWT秘密鍵 | 環境変数で管理（本番環境） |
| JWT有効期限 | 24時間（設定可能） |
| パスワードハッシュ | BCrypt（cost=10） |

### 8.2 制約事項

#### 8.2.1 技術的制約

| 制約 | 内容 | 理由 |
|------|------|------|
| ステートレス設計 | サーバーサイドセッションを使用しない | 水平スケーリング対応 |
| JWT認証のみ | Basic認証、OAuth2は未対応 | 初期リリースでは実装を簡素化 |
| CORS制限 | 許可されたオリジンのみアクセス可能 | セキュリティ対策 |

#### 8.2.2 機能的制約

| 制約 | 内容 | 理由 |
|------|------|------|
| 決済処理 | 決済方法の選択のみ実装、実際の決済は未実装 | 初期リリースでは外部連携は対象外 |
| メール送信 | 注文確認メール等のメール送信機能は未実装 | 初期リリースでは外部連携は対象外 |
| 管理機能 | 書籍・在庫・顧客の管理APIは未実装 | 初期リリースでは顧客向け機能に集中 |

---

## 9. 成功基準

本プロジェクトが成功したと判断される条件：

### 9.1 機能要件の充足

* [ ] 全APIエンドポイントが実装されている
* [ ] 全てのビジネスルールが実装されている
* [ ] JWT認証が正常に動作している
* [ ] 楽観的ロックが正常に動作している

### 9.2 非機能要件の充足

* [ ] APIレスポンスタイムが500ms以内である
* [ ] スループットが100 req/sec以上である
* [ ] 在庫不整合が発生しない

### 9.3 品質要件の充足

* [ ] 全てのエラーシナリオが適切に処理される
* [ ] サービス層のユニットテストカバレッジが80%以上
* [ ] 主要APIのE2Eテストが完了している

### 9.4 ドキュメント要件の充足

* [ ] 要件定義書（requirements.md）が完成している
* [ ] 振る舞い仕様書（behaviors.md）が完成している
* [ ] 機能設計書（functional_design.md）が完成している
* [ ] アーキテクチャ設計書（architecture_design.md）が完成している
* [ ] データモデル仕様書（data_model.md）が完成している
* [ ] 外部インターフェース仕様書（external_interface.md）が完成している
* [ ] APIドキュメント（README.md）が完成している

---

## 参考資料

本要件定義書に関連する詳細ドキュメント：

* [behaviors.md](behaviors.md) - 振る舞い仕様書（受入基準）
* [functional_design.md](functional_design.md) - 機能設計書（API仕様）
* [architecture_design.md](architecture_design.md) - アーキテクチャ設計書
* [data_model.md](data_model.md) - データモデル仕様書
* [external_interface.md](external_interface.md) - 外部インターフェース仕様書
* [README.md](../../README.md) - プロジェクトREADME
