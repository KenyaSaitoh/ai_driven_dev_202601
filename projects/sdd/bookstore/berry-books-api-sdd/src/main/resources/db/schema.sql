-- Berry Books API データベーススキーマ
-- HSQLDB 2.7.x

-- 出版社テーブル
CREATE TABLE PUBLISHER (
    PUBLISHER_ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    PUBLISHER_NAME VARCHAR(30) NOT NULL
);

-- カテゴリテーブル
CREATE TABLE CATEGORY (
    CATEGORY_ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CATEGORY_NAME VARCHAR(20) NOT NULL
);

-- 書籍テーブル
CREATE TABLE BOOK (
    BOOK_ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    BOOK_NAME VARCHAR(80) NOT NULL,
    AUTHOR VARCHAR(40) NOT NULL,
    CATEGORY_ID INTEGER NOT NULL,
    PUBLISHER_ID INTEGER NOT NULL,
    PRICE INTEGER NOT NULL,
    CONSTRAINT FK_BOOK_CATEGORY FOREIGN KEY (CATEGORY_ID) REFERENCES CATEGORY(CATEGORY_ID),
    CONSTRAINT FK_BOOK_PUBLISHER FOREIGN KEY (PUBLISHER_ID) REFERENCES PUBLISHER(PUBLISHER_ID)
);

-- 在庫テーブル（楽観的ロック用VERSIONカラム）
CREATE TABLE STOCK (
    BOOK_ID INTEGER PRIMARY KEY,
    QUANTITY INTEGER NOT NULL,
    VERSION BIGINT NOT NULL DEFAULT 0,
    CONSTRAINT FK_STOCK_BOOK FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID)
);

-- 顧客テーブル
CREATE TABLE CUSTOMER (
    CUSTOMER_ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    CUSTOMER_NAME VARCHAR(30) NOT NULL,
    PASSWORD VARCHAR(60) NOT NULL,
    EMAIL VARCHAR(30) NOT NULL UNIQUE,
    BIRTHDAY DATE,
    ADDRESS VARCHAR(120)
);

-- 注文トランザクションテーブル
CREATE TABLE ORDER_TRAN (
    ORDER_TRAN_ID INTEGER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    ORDER_DATE DATE NOT NULL,
    CUSTOMER_ID INTEGER NOT NULL,
    TOTAL_PRICE INTEGER NOT NULL,
    DELIVERY_PRICE INTEGER NOT NULL,
    DELIVERY_ADDRESS VARCHAR(30) NOT NULL,
    SETTLEMENT_TYPE INTEGER NOT NULL,
    CONSTRAINT FK_ORDER_TRAN_CUSTOMER FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMER(CUSTOMER_ID)
);

-- 注文明細テーブル（複合主キー）
CREATE TABLE ORDER_DETAIL (
    ORDER_TRAN_ID INTEGER NOT NULL,
    ORDER_DETAIL_ID INTEGER NOT NULL,
    BOOK_ID INTEGER NOT NULL,
    PRICE INTEGER NOT NULL,
    COUNT INTEGER NOT NULL,
    PRIMARY KEY (ORDER_TRAN_ID, ORDER_DETAIL_ID),
    CONSTRAINT FK_ORDER_DETAIL_TRAN FOREIGN KEY (ORDER_TRAN_ID) REFERENCES ORDER_TRAN(ORDER_TRAN_ID),
    CONSTRAINT FK_ORDER_DETAIL_BOOK FOREIGN KEY (BOOK_ID) REFERENCES BOOK(BOOK_ID)
);

