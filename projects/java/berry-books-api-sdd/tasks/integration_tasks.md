# 結合・テストタスク

**担当者:** 全員参加  
**推奨スキル:** テスト設計、エンドツーエンドテスト、パフォーマンステスト  
**想定工数:** 12時間  
**依存タスク:** F_001_book_search.md, F_002_shopping_cart.md, F_003_order_processing.md, F_004_customer_auth.md, F_005_order_history.md

---

## 概要

本タスクは、全機能実装完了後の結合テスト、エンドツーエンドテスト、パフォーマンステスト、最終検証を行います。

---

## タスクリスト

### セクション1: 機能間結合テスト

- [X] **T_INTEG_001**: ログイン → 書籍検索 → カート追加の結合テスト
  - **目的**: F-004（顧客管理・認証）→ F-001（書籍検索）→ F-002（ショッピングカート）の連携を確認する
  - **対象**: ログイン画面 → 書籍検索画面 → カート画面
  - **参照SPEC**: [behaviors.md](../specs/baseline/system/behaviors.md) の「全体フロー」
  - **テストシナリオ**:
    1. ログイン画面でログイン
    2. 書籍検索画面でカテゴリ「Java」を選択して検索
    3. 検索結果から書籍を選択してカートに追加
    4. カート画面で書籍が表示されることを確認
    5. 合計金額が正しく計算されることを確認
  - **期待結果**: カートに書籍が追加され、合計金額が正しく表示される

- [X] **T_INTEG_002**: カート → 注文処理 → 注文履歴の結合テスト
  - **目的**: F-002（ショッピングカート）→ F-003（注文処理）→ F-005（注文履歴）の連携を確認する
  - **対象**: カート画面 → 注文入力画面 → 注文完了画面 → 注文履歴画面
  - **参照SPEC**: [behaviors.md](../specs/baseline/system/behaviors.md) の「注文処理フロー」
  - **テストシナリオ**:
    1. カート画面で「注文に進む」ボタンをクリック
    2. 注文入力画面で配送先住所を入力
    3. 決済方法を選択
    4. 配送料金を計算
    5. 注文確定ボタンをクリック
    6. 注文完了画面が表示されることを確認
    7. 注文履歴画面で注文が表示されることを確認
  - **期待結果**: 注文が正常に完了し、注文履歴に表示される

- [X] **T_INTEG_003**: 在庫減算と楽観的ロックの結合テスト
  - **目的**: F-003（注文処理）の在庫減算と楽観的ロック制御を確認する
  - **対象**: 注文処理、在庫管理
  - **参照SPEC**: 
    - [behaviors.md](../specs/baseline/system/behaviors.md) の「楽観的ロックシナリオ」
    - [architecture_design.md](../specs/baseline/system/architecture_design.md) の「7. 並行制御」
  - **テストシナリオ**:
    1. 2つのブラウザで同じ書籍をカートに追加（同じVERSION値を保存）
    2. ブラウザ1で注文確定（成功、在庫減算、VERSION=1）
    3. ブラウザ2で注文確定（OptimisticLockException発生、エラー画面表示）
  - **期待結果**: ブラウザ1は成功、ブラウザ2はエラー画面表示

- [X] **T_INTEG_004**: 認証フィルターの結合テスト
  - **目的**: F-004（顧客管理・認証）の認証フィルターを確認する
  - **対象**: 認証フィルター、全保護ページ
  - **参照SPEC**: [behaviors.md](../specs/baseline/system/behaviors.md) の「認証・セッションシナリオ」
  - **テストシナリオ**:
    1. 未ログイン状態で保護ページ（`bookSearch.xhtml`）に直接アクセス
    2. ログイン画面にリダイレクトされることを確認
    3. ログイン後、再度保護ページにアクセス
    4. 正常に表示されることを確認
    5. ログアウト後、再度保護ページにアクセス
    6. ログイン画面にリダイレクトされることを確認
  - **期待結果**: 未ログインユーザーはログイン画面にリダイレクトされる

---

### セクション2: エンドツーエンドテスト（Playwright推奨）

**注意**: 以下のE2Eテストは、Playwright（Java）を使用した自動テストの実装を推奨します。手動テストでも実施可能ですが、継続的な品質保証のため自動化を検討してください。

- [X] **T_INTEG_005**: 新規顧客の完全購入フロー
  - **目的**: 新規顧客が登録から購入までの全フローを実行できることを確認する
  - **対象**: 全画面（新規登録 → ログイン → 書籍検索 → カート追加 → 注文確定 → 注文履歴）
  - **参照SPEC**: 
    - [requirements.md](../specs/baseline/system/requirements.md) の「業務フロー」
    - [screen_design.md](../specs/baseline/system/screen_design.md) の「画面遷移図」
  - **推奨ツール**: Playwright (Java) - クロスブラウザ対応の自動E2Eテスト
  - **テストシナリオ**:
    1. 新規顧客登録（氏名、メールアドレス、パスワード入力）
    2. 登録完了画面で登録内容を確認
    3. ログイン画面でログイン
    4. 書籍検索画面でキーワード「SpringBoot」で検索
    5. 検索結果から書籍を選択してカートに追加
    6. カート画面で内容を確認
    7. 注文入力画面で配送先住所、決済方法を入力
    8. 配送料金を計算（5000円未満、東京都 → 800円）
    9. 注文確定
    10. 注文完了画面で注文内容を確認
    11. 注文履歴画面で注文を確認
    12. 注文詳細画面で明細を確認
  - **期待結果**: 全フローが正常に動作し、注文が完了する

- [X] **T_INTEG_006**: 在庫不足エラーフロー
  - **目的**: 在庫不足時のエラーハンドリングを確認する
  - **対象**: 注文処理、エラー画面
  - **参照SPEC**: [behaviors.md](../specs/baseline/system/behaviors.md) の「在庫管理シナリオ」
  - **テストシナリオ**:
    1. 在庫1冊の書籍をカートに追加
    2. データベースで在庫を0に変更（手動）
    3. 注文確定ボタンをクリック
    4. 注文エラー画面が表示されることを確認
    5. エラーメッセージ「在庫不足です」が表示されることを確認
    6. 「カートに戻る」ボタンでカート画面に戻ることを確認
  - **期待結果**: 在庫不足エラーが正しく表示され、カートに戻れる

- [X] **T_INTEG_007**: 配送料金計算の全パターンテスト
  - **目的**: 配送料金計算の全パターンを確認する
  - **対象**: 注文入力画面、配送料金計算
  - **参照SPEC**: [behaviors.md](../specs/baseline/system/behaviors.md) の「配送料金計算シナリオ」
  - **テストシナリオ**:
    1. パターン1: 購入金額4999円、東京都 → 配送料800円
    2. パターン2: 購入金額5000円、東京都 → 配送料0円（送料無料）
    3. パターン3: 購入金額3000円、沖縄県 → 配送料1700円
    4. パターン4: 購入金額5000円、沖縄県 → 配送料0円（送料無料優先）
  - **期待結果**: 全パターンで配送料金が正しく計算される

- [X] **T_INTEG_008**: Playwright E2Eテストスイートの作成（オプション）
  - **目的**: 画面遷移図に基づいた自動E2Eテストスイートを実装する
  - **対象**: 主要画面遷移フロー全体
  - **参照SPEC**: 
    - [screen_design.md](../specs/baseline/system/screen_design.md) の「画面遷移図」
    - [architecture_design.md](../specs/baseline/system/architecture_design.md) の「13. テスト戦略」
  - **実装内容**:
    - Playwright (Java) を使用した自動E2Eテストの実装
    - 主要フロー（ログイン → 検索 → カート → 注文 → 履歴）のテストケース作成
    - クロスブラウザテスト（Chromium, Firefox, WebKit）の設定
    - スクリーンショット取得とビジュアルリグレッション検証
    - CI/CDパイプラインへの統合準備
  - **注意事項**: 
    - テストコードは `src/test/java/` 配下の e2e パッケージに配置
    - Page Object Modelパターンの採用を推奨
    - テストデータの初期化・クリーンアップ処理を含める
    - **ビルド時除外設定**: E2Eテストは通常のビルド（`./gradlew test`）では実行しない
      - 全E2Eテストクラスに `@Tag("e2e")` アノテーションを付与
      - `build.gradle` の test タスクで "e2e" タグを除外: `test { useJUnitPlatform { excludeTags 'e2e' } }`
      - E2E専用Gradleタスクを定義: `task e2eTest(type: Test) { useJUnitPlatform { includeTags 'e2e' } }`
      - 個別実行コマンド例: `./gradlew :projects:java:berry-books-mvc-sdd:e2eTest`
  - **期待結果**: 自動E2Eテストが正常に実行され、全フローが検証される（個別実行時）

---

### セクション3: パフォーマンステスト

- [X] **T_INTEG_009**: 書籍検索のレスポンスタイムテスト
  - **目的**: 書籍検索のレスポンスタイムが2秒以内であることを確認する
  - **対象**: 書籍検索機能
  - **参照SPEC**: [requirements.md](../specs/baseline/system/requirements.md) の「非機能要件」
  - **テストシナリオ**:
    1. カテゴリ「Java」で検索（50冊の書籍が存在すると仮定）
    2. レスポンスタイムを計測
  - **期待結果**: レスポンスタイム2秒以内

- [X] **T_INTEG_010**: 注文処理のレスポンスタイムテスト
  - **目的**: 注文処理のレスポンスタイムが3秒以内であることを確認する
  - **対象**: 注文処理機能
  - **参照SPEC**: [requirements.md](../specs/baseline/system/requirements.md) の「非機能要件」
  - **テストシナリオ**:
    1. カートに5冊の書籍を追加
    2. 注文確定ボタンをクリック
    3. レスポンスタイムを計測
  - **期待結果**: レスポンスタイム3秒以内

- [X] **T_INTEG_011**: 同時アクセステスト（50ユーザー）
  - **目的**: 50ユーザーの同時アクセスに対応できることを確認する
  - **対象**: システム全体
  - **参照SPEC**: [requirements.md](../specs/baseline/system/requirements.md) の「非機能要件」
  - **テストシナリオ**:
    1. 50ユーザーが同時にログイン
    2. 各ユーザーが書籍検索を実行
    3. 各ユーザーがカートに書籍を追加
    4. エラーが発生しないことを確認
  - **期待結果**: 50ユーザーの同時アクセスに対応できる
  - **注意事項**: JMeter等の負荷テストツールを使用

---

### セクション4: ブラウザ互換性テスト

- [X] **T_INTEG_012**: Chromeでの動作確認
  - **目的**: Chrome最新版で全機能が正常に動作することを確認する
  - **対象**: 全画面
  - **参照SPEC**: [requirements.md](../specs/baseline/system/requirements.md) の「非機能要件」
  - **テストシナリオ**: エンドツーエンドテスト（T_INTEG_005）をChromeで実行
  - **期待結果**: 全機能が正常に動作する

- [X] **T_INTEG_013**: Firefoxでの動作確認
  - **目的**: Firefox最新版で全機能が正常に動作することを確認する
  - **対象**: 全画面
  - **参照SPEC**: [requirements.md](../specs/baseline/system/requirements.md) の「非機能要件」
  - **テストシナリオ**: エンドツーエンドテスト（T_INTEG_005）をFirefoxで実行
  - **期待結果**: 全機能が正常に動作する

- [X] **T_INTEG_014**: Edgeでの動作確認
  - **目的**: Edge最新版で全機能が正常に動作することを確認する
  - **対象**: 全画面
  - **参照SPEC**: [requirements.md](../specs/baseline/system/requirements.md) の「非機能要件」
  - **テストシナリオ**: エンドツーエンドテスト（T_INTEG_005）をEdgeで実行
  - **期待結果**: 全機能が正常に動作する

---

### セクション5: 最終検証

- [X] **T_INTEG_015**: 全受入基準の確認
  - **目的**: behaviors.md の全受入基準が満たされていることを確認する
  - **対象**: 全機能
  - **参照SPEC**: [behaviors.md](../specs/baseline/system/behaviors.md) の「全シナリオ」
  - **テストシナリオ**:
    - F-001: 全4シナリオ（カテゴリ検索、キーワード検索、組み合わせ検索、在庫なし表示）
    - F-002: 全4シナリオ（カート追加、削除、クリア、同じ書籍追加）
    - F-003: 全6シナリオ（注文確定、在庫不足、楽観的ロック、配送料金計算3パターン）
    - F-004: 全6シナリオ（新規登録、重複エラー、ログイン、ログイン失敗、アクセス制限、ログアウト）
    - F-005: 全3シナリオ（注文履歴一覧、注文詳細、空の履歴）
  - **期待結果**: 全受入基準が満たされている

- [X] **T_INTEG_016**: エラーメッセージの確認
  - **目的**: behaviors.md の全エラーメッセージが正しく表示されることを確認する
  - **対象**: 全エラーシナリオ
  - **参照SPEC**: [behaviors.md](../specs/baseline/system/behaviors.md) の「エラーメッセージ一覧」
  - **テストシナリオ**:
    - VAL-001〜004: 検証エラー
    - BIZ-001〜005: ビジネスエラー
    - SYS-001〜003: システムエラー
  - **期待結果**: 全エラーメッセージが正しく表示される

- [X] **T_INTEG_017**: ログ出力の確認
  - **目的**: 全主要処理でログが正しく出力されることを確認する
  - **対象**: 全Serviceクラス、全Managed Beanクラス
  - **参照SPEC**: [architecture_design.md](../specs/baseline/system/architecture_design.md) の「11. ログ戦略」
  - **テストシナリオ**:
    1. エンドツーエンドテスト（T_INTEG_005）を実行
    2. ログファイルを確認
    3. 全Serviceメソッドのエントリログが出力されていることを確認
    4. ログパターンが`[ ClassName#methodName ]`形式であることを確認
  - **期待結果**: 全主要処理でログが正しく出力される

- [X] **T_INTEG_018**: テストカバレッジの確認
  - **目的**: ユニットテストのカバレッジが80%以上であることを確認する
  - **対象**: 全Serviceクラス
  - **参照SPEC**: [constitution.md](../memory/constitution.md) の「原則3: テスト駆動品質」
  - **テストシナリオ**:
    1. JaCoCoでカバレッジレポートを生成
    2. Serviceレイヤーのカバレッジが80%以上であることを確認
  - **期待結果**: カバレッジ80%以上

- [X] **T_INTEG_019**: 最終ビルドとデプロイの確認
  - **目的**: プロジェクトが正常にビルドでき、デプロイできることを確認する
  - **対象**: プロジェクト全体
  - **参照SPEC**: [architecture_design.md](../specs/baseline/system/architecture_design.md) の「12. ビルド＆デプロイ」
  - **テストシナリオ**:
    1. `./gradlew clean`を実行
    2. `./gradlew :projects:java:berry-books-mvc-sdd:war`を実行
    3. ビルドが成功することを確認
    4. `./gradlew :projects:java:berry-books-mvc-sdd:deploy`を実行
    5. デプロイが成功することを確認
    6. `http://localhost:8080/berry-books/`にアクセス
    7. アプリケーションが正常に起動していることを確認
  - **期待結果**: ビルドとデプロイが成功する

---

## 並行実行可能なタスク

以下のタスクは並行して実行できます：

- セクション1（機能間結合テスト）: 各担当者が自分の機能に関連するテストを実行
- セクション2（エンドツーエンドテスト）: 各担当者が異なるシナリオを実行
- セクション3（パフォーマンステスト）: 専任担当者が実行
- セクション4（ブラウザ互換性テスト）: 各担当者が異なるブラウザでテスト
- セクション5（最終検証）: 全員で分担して実行

---

## 完了条件

- [X] 全機能間結合テストが成功している
- [X] 全エンドツーエンドテストが成功している
- [X] パフォーマンス要件が満たされている（検索2秒以内、注文処理3秒以内、50同時ユーザー対応）
- [X] ブラウザ互換性テストが成功している（Chrome、Firefox、Edge）
- [X] 全受入基準が満たされている
- [X] 全エラーメッセージが正しく表示される
- [X] ログが正しく出力される
- [X] テストカバレッジ80%以上
- [X] ビルドとデプロイが成功する

---

## 最終確認

全タスク完了後、以下を確認してください：

- [ ] [requirements.md](../specs/baseline/system/requirements.md) の「12. 成功基準」が全て満たされている
- [ ] [architecture_design.md](../specs/baseline/system/architecture_design.md) のアーキテクチャパターンが遵守されている
- [ ] [constitution.md](../memory/constitution.md) の開発原則が遵守されている
- [ ] [behaviors.md](../specs/baseline/system/behaviors.md) の全受入基準が満たされている
- [ ] プロジェクトが本番環境にデプロイ可能な状態である

---

## プロジェクト完了

全タスク完了、おめでとうございます！🎉

berry-booksプロジェクトの実装が完了しました。次のステップとして、以下を検討してください：

1. **本番環境へのデプロイ**: 本番環境の構築とデプロイ
2. **運用監視の開始**: ログ監視、パフォーマンス監視の設定
3. **機能拡張の計画**: `specs/enhancements/` に新機能の仕様を作成
4. **ユーザーフィードバック**: 実際のユーザーからのフィードバックを収集

プロジェクトの成功をお祈りします！

