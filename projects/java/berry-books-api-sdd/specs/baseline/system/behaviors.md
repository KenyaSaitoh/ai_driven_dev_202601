# berry-books - 振る舞い仕様書

**プロジェクトID:** berry-books  
**バージョン:** 1.1.4  
**最終更新日:** 2025-12-21  
**ステータス:** 受入基準詳細化（セッション管理・画面初期表示・注文明細永続化・画面遷移・UI/UX改善）

---

## 概要

このドキュメントは、berry-booksシステムの外形的な振る舞いの概要を定義する。
各シナリオはGiven-When-Then形式で記述され、ブラックボックステストの基礎となる。

各機能の詳細な振る舞い仕様は、機能ごとに分割されたドキュメントを参照してください。

**関連ドキュメント:**
- [requirements.md](requirements.md) - ビジネス要件（What & Why）
- [functional_design.md](functional_design.md) - 機能設計（Flows & UI）
- [architecture_design.md](architecture_design.md) - アーキテクチャ設計
- [data_model.md](data_model.md) - データモデル

---

## 画面マッピング

このドキュメントで参照する画面とファイル名の対応：

| 画面ID | 画面名 | ファイル名 | 認証要否 |
|--------|--------|-----------|---------|
| SC-001 | ログイン画面 | index.xhtml | 不要 |
| SC-002 | 新規登録画面 | customerInput.xhtml | 不要 |
| SC-003 | 登録完了画面 | customerOutput.xhtml | 不要 |
| SC-004 | 書籍検索画面 | bookSearch.xhtml | 必要 |
| SC-005 | 検索結果画面 | bookSelect.xhtml | 必要 |
| SC-006 | カート画面 | cartView.xhtml | 必要 |
| SC-007 | 注文入力画面 | bookOrder.xhtml | 必要 |
| SC-008 | 注文完了画面 | orderSuccess.xhtml | 必要 |
| SC-009 | 注文エラー画面 | orderError.xhtml | 必要 |
| SC-010 | 注文履歴画面 | orderHistory.xhtml | 必要 |
| SC-011 | 注文詳細画面 | orderDetail.xhtml | 必要 |

---

## 機能別シナリオ一覧

### F-001: 書籍検索・閲覧

**詳細:** [../features/F_001_book_search/behaviors.md](../features/F_001_book_search/behaviors.md)

- Scenario 1: カテゴリで書籍を絞り込む
- Scenario 2: キーワードで書籍を検索する
- Scenario 3: カテゴリとキーワードを組み合わせて検索する
- Scenario 4: 在庫なしの書籍も表示される
- Scenario 5: 検索結果がリダイレクト後も保持される（@SessionScoped）

**振る舞いの実装詳細:**
- `BookSearchBean`は`@SessionScoped`を使用
- `search()`メソッドが`faces-redirect=true`でリダイレクトしても、`bookList`が保持される
- 画像ファイル名は`bookName.replace(" ", "_") + ".jpg"`で生成
- 例: 「Java SEディープダイブ」→ 「Java_SEディープダイブ.jpg」

### F-002: ショッピングカート管理

**詳細:** [../features/F_002_shopping_cart/behaviors.md](../features/F_002_shopping_cart/behaviors.md)

- Scenario 1: 書籍をカートに追加する
- Scenario 2: カート内の書籍を削除する
- Scenario 3: カート全体をクリアする
- Scenario 4: 同じ書籍を複数回追加する

### F-003: 注文処理

**詳細:** [../features/F_003_order_processing/behaviors.md](../features/F_003_order_processing/behaviors.md)

- Scenario 1: 注文を確定する（正常系）
- Scenario 2: 在庫不足エラー（異常系）
- Scenario 3: 同時注文による競合（楽観的ロック）
- Scenario 4: 配送料金の自動計算（通常）
- Scenario 5: 沖縄県への配送料金
- Scenario 6: 送料無料（5000円以上）
- Scenario 7: 注文画面初期表示時に配送先住所がデフォルト表示される
- Scenario 8: 注文明細が正常に永続化される（ORDER_TRAN_IDがNULLにならない）

**振る舞いの実装詳細:**
- **配送先住所のデフォルト値**:
  - `OrderBean.init()`で`customerBean.getCustomer().getAddress()`を取得
  - REST API経由で取得したログインユーザーの住所を`deliveryAddress`にデフォルト設定
  - ユーザーは必要に応じて編集可能
  - 例: Aliceユーザーの場合、「東京都中央区1-1-1」が自動入力される

- **注文明細の永続化（BR-027）**:
  - `OrderDetail`エンティティの`@ManyToOne`関係に`@MapsId("orderTranId")`を使用
  - 複合主キーの`orderTranId`が`orderTran`関係から自動的に設定される
  - `OrderService.orderBooks()`で、`orderDetail.setOrderTran(orderTran)`を明示的に呼び出す
  - これにより、INSERT文に`ORDER_TRAN_ID`が正しく含まれる
  - エラー回避: `integrity constraint violation: NOT NULL check constraint table: ORDER_DETAIL column: ORDER_TRAN_ID`

### F-004: 顧客管理・認証

**詳細:** [../features/F_004_customer_auth/behaviors.md](../features/F_004_customer_auth/behaviors.md)

- Scenario 1: 新規顧客登録（正常系）
- Scenario 2: メールアドレス重複エラー（異常系）
- Scenario 3: ログイン（正常系）
- Scenario 4: ログイン失敗（異常系）
- Scenario 5: 未ログインユーザーのアクセス制限
- Scenario 6: ログアウト

### F-005: 注文履歴参照

**詳細:** [../features/F_005_order_history/behaviors.md](../features/F_005_order_history/behaviors.md)

- Scenario 1: 注文履歴一覧を表示する
- Scenario 2: 注文詳細を表示する
- Scenario 3: 注文履歴が空の場合

---

## 例外・エラーシナリオ

### 在庫管理

| シナリオ | 期待される動作 | エラーコード | 詳細ドキュメント |
|----------|-------------------|-------------|-----------------|
| 在庫0の書籍を検索 | 検索結果に表示（BR-004）、「カートへ」ボタン無効化 | - | F-001 |
| カート追加後に在庫0になった | 注文確定時に在庫不足エラー | BIZ-003 | F-003 |
| 複数ユーザーが同時購入 | 先着順成功、後続ユーザーはOptimisticLockException | BIZ-004 | F-003 |
| 在庫数より多い数量を注文 | 注文確定時にエラー、カート保持 | BIZ-003 | F-003 |
| マイナス数量でカート追加 | クライアント検証エラー | VAL-004 | F-002 |
| 0数量でカート追加 | クライアント検証エラー | VAL-004 | F-002 |

### 認証・セッション

| シナリオ | 期待される動作 | エラーコード | 詳細ドキュメント |
|----------|-------------------|-------------|-----------------|
| セッションタイムアウト（60分） | ログイン画面にリダイレクト | - | F-004 |
| 直接URL入力（未ログイン） | AuthenticationFilterでログイン画面にリダイレクト（BR-034） | - | F-004 |
| ログアウト後のブラウザバック | AuthenticationFilterでログイン画面にリダイレクト | - | F-004 |
| 重複ログイン | 最新のセッションのみ有効（古いセッションは無効化） | - | F-004 |
| 不正なメールアドレスでログイン | 認証失敗 | BIZ-002 | F-004 |
| パスワード未入力でログイン | クライアント検証エラー | VAL-002 | F-004 |
| メールアドレス未入力でログイン | クライアント検証エラー | VAL-001 | F-004 |

**セッション管理の実装詳細:**
- `LoginBean`は`@SessionScoped`で定義され、ログイン状態を管理
- ログイン成功時: `loginBean.loggedIn = true`を設定し、`CustomerBean`に顧客情報を設定
- ログアウト時: `FacesContext.getExternalContext().invalidateSession()`でセッション全体を無効化
- `AuthenticationFilter`は`@Inject LoginBean`経由で`loginBean.isLoggedIn()`をチェック
- これにより、CDI BeanをServlet Filterから直接利用可能

### カート操作

| シナリオ | 期待される動作 | エラーコード | 詳細ドキュメント |
|----------|-------------------|-------------|-----------------|
| 空カートで注文画面へ遷移 | エラーメッセージ表示、注文画面に遷移しない | BIZ-005 | F-002 |
| カート内の書籍がデータベースから削除された | 注文時にエラー（書籍が見つからない） | SYS-001 | F-002 |
| カート内の価格が変更された | カート追加時の価格で注文（CartItemに保存済み） | - | F-002 |
| セッション内のカートが破損 | システムエラー | SYS-001 | F-002 |
| 同じ書籍を最大在庫数以上カート追加 | クライアント検証または注文時エラー | BIZ-003 | F-002 |

### 入力検証

| シナリオ | 期待される動作 | エラーコード | 詳細ドキュメント |
|----------|-------------------|-------------|-----------------|
| 顧客名未入力で登録 | クライアント検証エラー | VAL-001 | F-004 |
| メールアドレス形式不正で登録 | クライアント検証エラー | VAL-001 | F-004 |
| 配送先住所未入力で注文 | クライアント検証エラー | VAL-003 | F-003 |
| 決済方法未選択で注文 | クライアント検証エラー | - | F-003 |
| 重複メールアドレスで登録 | ビジネスロジックエラー（BR-030） | BIZ-001 | F-004 |

### 配送料金計算

| シナリオ | 期待される動作 | 計算ロジック | 詳細ドキュメント |
|----------|-------------------|-------------|-----------------|
| 購入金額4999円（東京都） | 配送料800円 | 5000円未満 & 非沖縄 | F-003 |
| 購入金額5000円（東京都） | 配送料0円（送料無料） | 5000円以上 | F-003 |
| 購入金額5001円（東京都） | 配送料0円（送料無料） | 5000円以上 | F-003 |
| 購入金額3000円（沖縄県） | 配送料1700円 | 5000円未満 & 沖縄 | F-003 |
| 購入金額5000円（沖縄県） | 配送料0円（送料無料） | 5000円以上優先 | F-003 |
| 購入金額3000円（大阪府） | 配送料800円 | 5000円未満 & 非沖縄 | F-003 |

### データ整合性

| シナリオ | 期待される動作 | 関連ルール | 詳細ドキュメント |
|----------|-------------------|-------------|-----------------|
| ORDER_DETAIL永続化でORDER_TRAN_IDがNULL | `@MapsId`により自動設定、NOT NULL制約違反を回避 | BR-027 | architecture_design.md §7.3 |
| 複合主キーの不正設定 | エンティティ設計時に`@MapsId`使用、実行時エラー防止 | BR-027 | architecture_design.md §7.3 |

**実装詳細（BR-027）:**
- `OrderDetail`エンティティの`@ManyToOne`関係に`@MapsId("orderTranId")`アノテーションを使用
- これにより、`orderTran`を設定するだけで、複合主キーの`orderTranId`が自動的に設定される
- `insertable=false, updatable=false`を使用すると、JPAがINSERT文に`ORDER_TRAN_ID`を含めないため、NOT NULL制約違反が発生する
- 修正前: `@JoinColumn(name = "ORDER_TRAN_ID", insertable = false, updatable = false)`
- 修正後: `@JoinColumn(name = "ORDER_TRAN_ID")` + `@MapsId("orderTranId")`

---

## エラーメッセージ一覧

### 検証エラー（VAL-xxx）

| コード | メッセージ | 発生条件 |
|--------|-----------|---------|
| VAL-001 | {フィールド名}を入力してください | 必須フィールド未入力 |
| VAL-002 | パスワードを入力してください | パスワード未入力 |
| VAL-003 | 配送先住所を入力してください | 住所未入力 |
| VAL-004 | 数量は1以上を入力してください | 数量が0以下 |

### ビジネスエラー（BIZ-xxx）

| コード | メッセージ | 発生条件 | 例外クラス |
|--------|-----------|---------|-----------|
| BIZ-001 | メールアドレスが既に登録されています | メールアドレス重複（BR-030） | EmailAlreadyExistsException |
| BIZ-002 | メールアドレスまたはパスワードが正しくありません | 認証失敗 | - |
| BIZ-003 | 在庫が不足しています | 注文数 > 在庫数 | OutOfStockException |
| BIZ-004 | 他のユーザーが購入済みです。カートを確認してください | 楽観的ロック競合（BR-024） | OptimisticLockException |
| BIZ-005 | カートが空です | 空カートで注文試行 | - |

### システムエラー（SYS-xxx）

| コード | メッセージ | 発生条件 |
|--------|-----------|---------|
| SYS-001 | システムエラーが発生しました | 予期しないエラー |
| SYS-002 | データベース接続エラー | DB接続失敗 |
| SYS-003 | トランザクションエラー | トランザクション失敗 |

---

## ビジネスルール参照

### 検索機能（F-001）

| ルールID | 説明 |
|---------|-------------|
| BR-001 | カテゴリ未選択の場合、全カテゴリが検索対象 |
| BR-002 | キーワード未入力の場合、書籍名と著者の両方を検索 |
| BR-003 | 検索結果は書籍ID昇順でソート |
| BR-004 | 在庫0の書籍も表示（購入不可） |

### カート管理（F-002）

| ルールID | 説明 |
|---------|-------------|
| BR-010 | カート内容はセッション単位で保持（ログアウトまで） |
| BR-011 | 同じ書籍を追加した場合、数量を加算 |
| BR-012 | カート追加時点の在庫バージョン番号を保存（楽観的ロック用） |
| BR-013 | カート内の合計金額は常に自動計算 |

### 注文処理（F-003）

| ルールID | 説明 | 詳細 |
|---------|-------------|------|
| BR-020 | 配送料金計算ルール | 通常800円、沖縄県1700円、5000円以上無料 |
| BR-021 | 決済方法選択肢 | 銀行振込(1)、クレジットカード(2)、着払い(3) |
| BR-022 | 在庫チェックタイミング | 注文確定時に全書籍の在庫を確認 |
| BR-023 | 在庫減算タイミング | 在庫チェック後、注文登録前に減算 |
| BR-024 | 楽観的ロック制御 | カート追加時のバージョン番号で在庫更新 |
| BR-025 | トランザクション範囲 | 在庫チェック〜注文登録〜在庫減算は単一トランザクション |
| BR-026 | 配送先住所のデフォルト値 | 注文入力画面の配送先住所は、REST APIで取得したログインユーザーの住所をデフォルトで表示 |
| BR-027 | 注文明細の永続化 | ORDER_DETAILエンティティは`@MapsId`を使用して、複合主キーとOrderTranとの関連を正しくマッピングする |

### 顧客管理・認証（F-004）

| ルールID | 説明 |
|---------|-------------|
| BR-030 | メールアドレスは一意（重複不可） |
| BR-031 | パスワードは平文保存（学習用のみ、本番環境では非推奨） |
| BR-032 | セッションタイムアウト: 60分 |
| BR-033 | 公開ページ: ログイン画面、新規登録画面、登録完了画面 |
| BR-034 | 公開ページ以外は認証必須 |

### 注文履歴参照（F-005）

| ルールID | 説明 |
|---------|-------------|
| BR-040 | 注文履歴は顧客IDでフィルタリング |
| BR-041 | 注文日降順（新しい順）でソート |
| BR-042 | 注文詳細は注文IDで取得 |

---

## テスト実行チェックリスト

### 機能テスト

- [ ] **F-001: 書籍検索・閲覧**: 全4シナリオ実行
- [ ] **F-002: ショッピングカート管理**: 全4シナリオ実行
- [ ] **F-003: 注文処理**: 全8シナリオ実行（正常系、在庫不足、楽観的ロック、配送料金計算3パターン、配送先住所デフォルト表示、注文明細永続化）
- [ ] **F-004: 顧客管理・認証**: 全6シナリオ実行
- [ ] **F-005: 注文履歴参照**: 全3シナリオ実行

### 例外・エラーテスト

- [ ] **在庫管理**: 全6ケース実行
- [ ] **認証・セッション**: 全7ケース実行
- [ ] **カート操作**: 全5ケース実行
- [ ] **入力検証**: 全5ケース実行
- [ ] **配送料金計算**: 全6ケース実行
- [ ] **データ整合性**: 全2ケース実行（ORDER_DETAIL永続化、複合主キー設定）

### ブラウザ互換性テスト

- [ ] Chrome最新版
- [ ] Firefox最新版
- [ ] Edge最新版

### パフォーマンステスト

- [ ] 50同時ユーザーでの動作確認
- [ ] レスポンスタイム3秒以内の確認

---

## 画面表示の振る舞い

### シナリオ: 検索結果画面で在庫数と購入可否を正しく表示する

**Given（前提条件）:**
- ログイン済み
- 「Java」カテゴリで書籍を検索
- 検索結果に在庫2の書籍が含まれる

**When（操作）:**
- 検索結果画面（bookSelect.xhtml）を表示

**Then（期待結果）:**
- 在庫数セルに「2」と表示される
- 操作セルに「カートへ」ボタンが表示され、有効化されている
- 「在庫なし」テキストは表示されない

**追加条件（在庫0の場合）:**
- 在庫数セルに「0」と表示される
- 操作セルに「在庫なし」テキストが表示される
- 「カートへ」ボタンは表示されない

**設計のポイント:**
- 在庫数は数値として常に表示（ユーザーに在庫状況を明示）
- 購入可否は在庫の有無で条件付き表示（ボタン表示/非表示を切り替え）
- 条件付き表示要素は別々のコンテナに配置（JSFレンダリングの予期しない動作を回避）

### シナリオ: 注文成功画面で注文情報を正しく表示する

**Given（前提条件）:**
- ログイン済み
- カートに書籍を追加済み
- 配送先住所と決済方法を入力済み

**When（操作）:**
- 注文確定ボタンをクリック
- 注文処理が成功
- 注文成功画面にリダイレクトされる（注文IDをURLパラメータとして引き継ぐ）

**Then（期待結果）:**
- 注文番号（例: #1）が表示される
- 注文日時（例: 2025年12月21日）が表示される
- 総合計（商品合計 + 配送料）が表示される
- 注文明細（書籍名、数量、価格）が表示される

**設計のポイント:**
- リダイレクト時に注文IDをURLパラメータとして渡す
- ビューメタデータでパラメータを受け取り、ビューアクションでデータをロード
- 注文データは明細を含めて一括取得（N+1問題回避）
- JSFライフサイクル: 初期化メソッド実行 → ビューパラメータ設定 → ビューアクション実行 → レンダリング

## 画面遷移とナビゲーション

### シナリオ: ログイン後に全書籍を一覧表示する

**Given（前提条件）:**
- ユーザーがログイン画面にアクセス
- 有効な認証情報を入力

**When（操作）:**
- ログインボタンをクリック

**Then（期待結果）:**
- 検索結果画面（bookSelect.xhtml）に遷移
- 全書籍が一覧表示される
- ユーザーは検索操作なしで商品を閲覧・購入できる

**設計のポイント:**
- ログイン成功時の遷移先はbookSelect（検索画面ではない）
- BookSearchBeanの初期化時（@PostConstruct init()メソッド）に全書籍を取得
- bookSelect.xhtmlのpreRenderViewイベントでrefreshBookList()を呼び出し、在庫数を最新化
- ユーザーが迷わずショッピングを開始できるUX設計

### シナリオ: カートから買い物を続ける

**Given（前提条件）:**
- カート画面（cartView.xhtml）を表示中
- カートに1つ以上の商品がある

**When（操作）:**
- 「買い物を続ける」ボタンをクリック

**Then（期待結果）:**
- 検索結果画面（bookSelect.xhtml）に遷移
- 全書籍が一覧表示される
- ログイン直後と同じ状態で買い物を継続できる

**設計のポイント:**
- 遷移先はbookSelect（検索画面ではない）
- ユーザーが一貫した体験で買い物を継続できる

### シナリオ: 配送料金の自動計算

**Given（前提条件）:**
- カートに商品を追加済み
- 注文画面（bookOrder.xhtml）に遷移

**When（操作）:**
- 画面が表示される

**Then（期待結果）:**
- ログインユーザーの住所で配送料金が自動計算される
- 配送料金が画面に表示される
- 手動計算ボタンは表示されない

**追加条件（配送先住所変更時）:**
- 配送先住所を変更
- 「注文を確定する」ボタンをクリック
- 注文確定前に配送料金が自動的に再計算される

**設計のポイント:**
- 初期表示時: ログインユーザーの住所で自動計算
- 注文確定時: 変更された住所で自動再計算
- ユーザーが手動計算操作をする必要がない（UX簡素化）

---

## 機能別詳細ドキュメント

各機能の詳細な振る舞い仕様は、以下のドキュメントを参照してください。

### F-001: 書籍検索・閲覧
- [振る舞い仕様](../features/F_001_book_search/behaviors.md)

### F-002: ショッピングカート管理
- [振る舞い仕様](../features/F_002_shopping_cart/behaviors.md)

### F-003: 注文処理
- [振る舞い仕様](../features/F_003_order_processing/behaviors.md)

### F-004: 顧客管理・認証
- [振る舞い仕様](../features/F_004_customer_auth/behaviors.md)

### F-005: 注文履歴参照
- [振る舞い仕様](../features/F_005_order_history/behaviors.md)
